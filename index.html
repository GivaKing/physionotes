
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>PhysioNotes</title>
  
  <link rel="apple-touch-icon" sizes="180x180" href="/logo.ico">
  <meta name="apple-mobile-web-app-title" content="PhysioNotes">
  <meta name="apple-mobile-web-app-capable" content="yes">

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <style>
    :root {
      --primary: #2563eb;
      --primary-soft: #dbeafe;
      --bg: #f3f4f6;
      --card: #ffffff;
      --border: #e5e7eb;
      --text: #111827;
      --muted: #6b7280;
      --danger: #dc2626;
      --radius-lg: 16px;
      --radius-md: 12px;
      --radius-sm: 8px;
    }
    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
    }
    .app {
      max-width: 960px;
      margin: 0 auto;
      padding: 12px 12px 24px;
    }
    header {
      margin-bottom: 12px;
    }
    .title {
      font-size: 1.3rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .badge {
      font-size: 0.7rem;
      padding: 2px 6px;
      border-radius: 999px;
      background: var(--primary-soft);
      color: var(--primary);
    }
    .subtitle {
      font-size: 0.8rem;
      color: var(--muted);
      margin-top: 2px;
    }
    .tabs {
      display: flex;
      gap: 6px;
      background: #e5e7eb;
      border-radius: 999px;
      padding: 4px;
      margin: 12px 0;
    }
    .tab-btn {
      flex: 1;
      border: none;
      border-radius: 999px;
      padding: 8px 4px;
      font-size: 0.9rem;
      background: transparent;
      color: var(--muted);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
    }
    .tab-btn span.icon {
      font-size: 1.1rem;
    }
    .tab-btn.active {
      background: #fff;
      color: var(--primary);
      font-weight: 600;
      box-shadow: 0 1px 3px rgba(15, 23, 42, 0.15);
    }
    .card {
      background: var(--card);
      border-radius: var(--radius-lg);
      padding: 12px 12px 16px;
      box-shadow: 0 1px 3px rgba(15,23,42,0.06);
      border: 1px solid var(--border);
    }
    .section-title {
      font-size: 0.95rem;
      font-weight: 600;
      margin: 14px 0 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .section-title span {
      font-size: 0.8rem;
      color: var(--muted);
      font-weight: 400;
    }
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      border-radius: 999px;
      background: var(--primary-soft);
      color: var(--primary);
      font-size: 0.75rem;
    }
    .grid-2 {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
    }
    @media (min-width: 768px) {
      .grid-3-md {
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 8px;
      }
    }
    label {
      display: block;
      font-size: 0.75rem;
      color: var(--muted);
      margin-bottom: 2px;
    }
    input[type="text"],
    input[type="number"],
    select,
    textarea {
      width: 100%;
      padding: 8px 10px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      font-size: 0.85rem;
      outline: none;
      background: #f9fafb;
    }
    textarea {
      min-height: 70px;
      resize: vertical;
    }
    input:focus,
    select:focus,
    textarea:focus {
      border-color: var(--primary);
      background: #fff;
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.12);
    }
    .chips {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .chip {
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 0.8rem;
      border: 1px solid var(--border);
      background: #f9fafb;
    }
    .chip.selected {
      background: var(--primary-soft);
      border-color: var(--primary);
      color: var(--primary);
      font-weight: 500;
    }
    .row {
      margin-bottom: 8px;
    }
    .hint {
      font-size: 0.7rem;
      color: var(--muted);
      margin-top: 2px;
    }
    .slider-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .slider-row input[type=range] {
      flex: 1;
    }
    .slider-value {
      font-size: 0.8rem;
      min-width: 30px;
      text-align: right;
      color: var(--primary);
      font-weight: 600;
    }
    input[type=range] {
      -webkit-appearance: none;
      height: 4px;
      border-radius: 999px;
      background: #e5e7eb;
      outline: none;
    }
    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--primary);
      box-shadow: 0 1px 3px rgba(15,23,42,0.4);
      cursor: pointer;
    }
    .page {
      display: none;
      animation: fadeIn 0.15s ease-out;
    }
    .page.active {
      display: block;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(4px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .tagline-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 6px;
    }
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #10b981;
    }
    .status-text {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 0.75rem;
      color: var(--muted);
    }
    .pill-small {
      border-radius: 999px;
      padding: 3px 7px;
      font-size: 0.7rem;
      background: #fee2e2;
      color: var(--danger);
    }
    .divider {
      height: 1px;
      background: var(--border);
      margin: 10px 0;
    }
    .summary-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 10px;
      font-size: 0.8rem;
      padding: 4px 0;
    }
    .summary-label {
      color: var(--muted);
      min-width: 70px;
    }
    .summary-value {
      flex: 1;
      text-align: right;
      font-weight: 500;
    }
    .pill-group {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      justify-content: flex-end;
    }
    .pill-ghost {
      border-radius: 999px;
      padding: 2px 6px;
      font-size: 0.7rem;
      border: 1px solid #e5e7eb;
      color: var(--muted);
    }
    .bottom-space {
      height: 32px;
    }
    .sticky-footer {
      position: sticky;
      bottom: -8px;
      margin-top: 10px;
      padding-top: 6px;
      background: linear-gradient(to top, rgba(243,244,246,0.9) 50%, rgba(243,244,246,0));
    }
    .btn-row {
      display: flex;
      gap: 8px;
    }
    .btn {
      flex: 1;
      border-radius: 999px;
      padding: 10px 12px;
      font-size: 0.9rem;
      border: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    .btn-success{background:#16a34a;color:#fff;box-shadow:0 2px 4px rgba(22,163,74,.35)}
    .btn-primary {
      background: var(--primary);
      color: #fff;
      box-shadow: 0 2px 4px rgba(37,99,235,0.35);
    }
    .btn-outline {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--muted);
    }
    .pill-toggle-group {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
    }
    .pill-toggle {
      border-radius: 999px;
      padding: 4px 8px;
      border: 1px solid var(--border);
      font-size: 0.75rem;
      background: #f9fafb;
    }
    .pill-toggle.active {
      background: var(--primary-soft);
      border-color: var(--primary);
      color: var(--primary);
      font-weight: 500;
    }
  
    .case-row{display:flex;gap:10px;align-items:center;padding:10px 12px;border-bottom:1px solid var(--border);cursor:pointer;background:#fff;}
    .case-row:hover{background:#f9fafb;}
    .case-main{min-width:140px;flex:0 0 auto;}
    .case-name{font-weight:600;font-size:0.9rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .case-sub{font-size:0.78rem;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-top:2px;}
    .case-vas{font-size:0.78rem;color:var(--primary);font-weight:600;white-space:nowrap;}
    .case-actions{display:flex;gap:6px;}
    .btn-danger{background:var(--danger);color:#fff;}
    
  
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;font-weight:600}
    .badge.done{background:#e6f6ea;color:#1a7f37}
    .badge.draft{background:#fff4e5;color:#9a6700}
    .timeline{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
    .timeline .t-chip{padding:4px 8px;border-radius:8px;border:1px solid var(--border);cursor:pointer;font-size:0.75rem}
    .timeline .t-chip.active{background:var(--primary);color:#fff;border-color:var(--primary)}
    .warn{color:#b42318;font-weight:600}

    .btn-icon{border:none;background:transparent;padding:6px;border-radius:10px;cursor:pointer}
    .btn-icon:hover{background:#fee2e2}
    .btn-icon svg{width:18px;height:18px;display:block;fill:currentColor}
    .btn-icon.btn-danger{background:var(--danger);color:#fff;}
    .btn-icon.btn-danger:hover{background:#b91c1c;}

    
    .case-mid{
      flex:1;
      text-align:center;
      font-size:0.85rem;
      color:#111827;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }


  /* === Auth screen === */
  .hidden{display:none !important;}
  .auth-screen-wrap{
    min-height:100vh;
    display:flex;
    align-items:center;
    justify-content:center;
    background:#f3f4f6;
  }
  .auth-card{
    width:100%;
    max-width:520px;
    background:#ffffff;
    border-radius:16px;
    box-shadow:0 10px 25px rgba(0,0,0,0.08);
    padding:32px 36px 28px;
  }
  .auth-title{
    font-size:1.25rem;
    font-weight:700;
    color:#111827;
    margin-bottom:4px;
  }
  .auth-sub{
    font-size:0.9rem;
    color:#6b7280;
    margin-bottom:20px;
  }
  .auth-tabs{
    display:flex;
    gap:8px;
    background:#f3f4f6;
    padding:4px;
    border-radius:999px;
    margin-bottom:20px;
  }
  .auth-tab{
    flex:1;
    border-radius:999px;
    border:none;
    padding:8px 0;
    font-size:0.9rem;
    cursor:pointer;
    background:transparent;
    color:#6b7280;
    font-weight:500;
  }
  .auth-tab.active{
    background:#2563eb;
    color:#ffffff;
  }
  .auth-field{
    margin-bottom:14px;
  }
  .auth-label{
    display:block;
    font-size:0.8rem;
    color:#374151;
    margin-bottom:4px;
  }
  .auth-input{
    width:100%;
    border-radius:999px;
    border:1px solid #d1d5db;
    padding:10px 14px;
    font-size:0.9rem;
  }
  .auth-input:focus{
    outline:none;
    border-color:#2563eb;
    box-shadow:0 0 0 1px rgba(37,99,235,0.2);
  }
  .auth-btn{
    width:100%;
    border-radius:999px;
    border:none;
    padding:11px 16px;
    font-size:0.95rem;
    font-weight:600;
    background:#2563eb;
    color:#ffffff;
    cursor:pointer;
    margin-top:4px;
  }
  .auth-btn:hover{background:#1d4ed8;}
  .auth-error{
    margin-top:8px;
    font-size:0.8rem;
    color:#b91c1c;
    min-height:1em;
  }
  .auth-footer{
    margin-top:16px;
    font-size:0.78rem;
    color:#9ca3af;
    text-align:right;
  }

  .btn-logout{
    padding:6px 12px !important;
    border-radius:999px;
    border:1px solid #d1d5db;
    background:#ffffff;
    font-size:0.85rem;
    color:#4b5563;
  
    flex:0 0 auto;
    margin-left:auto;
    cursor:pointer;
  }
  .btn-logout:hover{
    background:#f3f4f6;
  }

</style>
</head>
<body>
  <!-- Auth Screen -->
  <div id="auth-screen" class="auth-screen-wrap">
    <div class="auth-card">
      <div class="auth-title">PhysioNotes ç™»å…¥</div>
      <div class="auth-sub">è«‹å…ˆç™»å…¥æˆ–è¨»å†Šå¸³è™Ÿï¼Œæ‰èƒ½é€²å…¥å€‹æ¡ˆç®¡ç†ç³»çµ±ã€‚</div>

      <div class="auth-tabs">
        <button type="button" class="auth-tab active" id="tab-login">ç™»å…¥</button>
        <button type="button" class="auth-tab" id="tab-signup">è¨»å†Š</button>
      </div>

      <div class="auth-field">
        <label class="auth-label" for="auth-email">Email</label>
        <input id="auth-email" type="email" class="auth-input" placeholder="you@example.com" autocomplete="email">
      </div>

      <div class="auth-field">
        <label class="auth-label" for="auth-password">å¯†ç¢¼</label>
        <input id="auth-password" type="password" class="auth-input" placeholder="è‡³å°‘ 6 ç¢¼" autocomplete="current-password">
      </div>

      <button type="button" class="auth-btn" id="btn-auth-submit">ç™»å…¥</button>
      <div class="auth-error" id="auth-error"></div>
      <div class="auth-footer">
        æœ¬ç³»çµ±ä½¿ç”¨ Supabase Auth å„²å­˜å¸³è™Ÿå¯†ç¢¼ã€‚
      </div>
    </div>
  </div>

  <!-- App Root -->
  <div id="app-root" class="app hidden">
    <header>
      <div class="title">
        PhysioNotes
        <span class="badge">ç¶²é ç‰ˆ</span>
        <button id="btn-logout" class="btn btn-outline btn-logout">ç™»å‡º</button>
      </div>
      <div class="tagline-row">
        <div class="subtitle">è«‹å…ˆç”±å€‹æ¡ˆå¡«å¯«è«®è©¢è³‡æ–™ï¼Œå†ç”±æ²»ç™‚å¸«é€²å…¥è©•ä¼°é ã€‚</div>

        <div class="status-text">
          <span class="status-dot"></span> è‡ªå‹•æš«å­˜ä¸­
        </div>        
      </div>
      <div class="tabs">
        <button class="tab-btn active" data-target="page-client">
          <span class="icon">ğŸ“</span>
          å€‹æ¡ˆå¡«å¯«
        </button>
        <button class="tab-btn" data-target="page-therapist">
          <span class="icon">ğŸ©º</span>
          æ²»ç™‚å¸«è©•ä¼°
        </button>
<button class="tab-btn" data-target="page-cases"><span class="icon">ğŸ“‹</span>å€‹æ¡ˆç®¡ç†</button>
      </div>
    </header>

    <!-- å€‹æ¡ˆå¡«å¯«é  -->
    <main id="page-client" class="page active">
      <div class="card">
        <div class="section-title">
          åŸºæœ¬è³‡æ–™
          <span>Basic Info</span>
        </div>
        <div class="grid-2">
          <div class="row">
            <label for="name">å§“å</label>
            <input id="name" name="name" type="text" placeholder="ä¾‹ï¼šç‹å°ç¾" data-field />
          </div>
          <div class="row">
            <label for="age">å¹´é½¡</label>
            <input id="age" name="age" type="number" inputmode="numeric" min="0" max="120" placeholder="30" data-field />
          </div>
        </div>
        <div class="grid-2">
          <div class="row">
            <label>æ€§åˆ¥</label>
            <div class="pill-toggle-group" data-field="gender" data-type="single">
              <button type="button" class="pill-toggle" data-value="ç”·">ç”·</button>
              <button type="button" class="pill-toggle" data-value="å¥³">å¥³</button>
              <button type="button" class="pill-toggle" data-value="å…¶ä»–">å…¶ä»–</button>
            </div>
          </div>
          <div class="row">
            <label for="job">è·æ¥­</label>
            <input id="job" name="job" type="text" placeholder="ä¾‹ï¼šè­¦å¯Ÿã€å·¥ç¨‹å¸«ã€å­¸ç”Ÿâ€¦" data-field />
          </div>
        </div>

        <div class="row">
          <label>ä¸»è¦ç”Ÿæ´»å‹æ…‹ï¼ˆå¯è¤‡é¸ï¼‰</label>
          <div class="chips" data-field="lifestyle" data-type="multi">
            <button type="button" class="chip" data-value="ä¹…å">ä¹…å</button>
            <button type="button" class="chip" data-value="ä¹…ç«™">ä¹…ç«™</button>
            <button type="button" class="chip" data-value="é‡ç‰©æ¬é‹">é‡ç‰©æ¬é‹</button>
            <button type="button" class="chip" data-value="å®¶å‹™/å¸¶å°å­©">å®¶å‹™ / å¸¶å°å­©</button>
            <button type="button" class="chip" data-value="é‹å‹•å“¡/é«˜æ´»å‹•é‡">é‹å‹•å“¡ / é«˜æ´»å‹•é‡</button>
          </div>
          <div class="hint">å¯å”åŠ©æ²»ç™‚å¸«å¿«é€Ÿäº†è§£æ—¥å¸¸è² è·ã€‚</div>
        </div>

        <div class="divider"></div>

        <div class="section-title">
          ä¸»è¨´èˆ‡ç—‡ç‹€
          <span>Chief Complaint</span>
        </div>

        <div class="row">
          <label for="main-complaint">ä¸»è¦ä¸é©éƒ¨ä½ / æ„Ÿå—</label>
          <textarea id="main-complaint" name="mainComplaint" placeholder="ä¾‹ï¼šå³å´è‡€éƒ¨å»¶ä¼¸åˆ°è…¿å¾Œå´ç–¼ç—›ï¼Œç›®å‰è®Šæˆå³è…³å‰è…³æŒéº»â€¦" data-field></textarea>
        </div>

        <div class="row">
          <label>ä¸é©é¡å‹ï¼ˆå¯è¤‡é¸ï¼‰</label>
          <div class="chips" data-field="painTypes" data-type="multi">
            <button type="button" class="chip" data-value="ç— ç—›">ç— ç—›</button>
            <button type="button" class="chip" data-value="ç·Šç¹ƒ">ç·Šç¹ƒ</button>
            <button type="button" class="chip" data-value="åˆºç—›">åˆºç—›</button>
            <button type="button" class="chip" data-value="éˆç—›">éˆç—›</button>
            <button type="button" class="chip" data-value="æ·±å±¤ç—›">æ·±å±¤ç—›</button>
            <button type="button" class="chip" data-value="æ·ºå±¤ç—›">æ·ºå±¤ç—›</button>
            <button type="button" class="chip" data-value="æ”¾å°„ç—›">æ”¾å°„ç—›</button>
            <button type="button" class="chip" data-value="å£“ç—›">å£“ç—›</button>
            <button type="button" class="chip" data-value="éº»æœ¨/é›»æµæ„Ÿ">éº»æœ¨ / é›»æµæ„Ÿ</button>
          </div>
        </div>

        <div class="row">
          <label>ç—‡ç‹€æŒçºŒæ™‚é–“</label>
          <div class="pill-toggle-group" data-field="duration" data-type="single">
            <button type="button" class="pill-toggle" data-value="ä¸€é€±å…§">ä¸€é€±å…§</button>
            <button type="button" class="pill-toggle" data-value="1â€“4 é€±">1â€“4 é€±</button>
            <button type="button" class="pill-toggle" data-value="1â€“3 å€‹æœˆ">1â€“3 å€‹æœˆ</button>
            <button type="button" class="pill-toggle" data-value="è¶…é 3 å€‹æœˆ">è¶…é 3 å€‹æœˆ</button>
          </div>
        </div>

        <div class="row">
          <label>ç›®å‰ç–¼ç—›ç¨‹åº¦ï¼ˆ0â€“10ï¼‰</label>
          <div class="slider-row">
            <input type="range" min="0" max="10" step="1" value="0" id="pain-now" data-field="painNow" />
            <span class="slider-value" id="pain-now-value">0</span>
          </div>
          <div class="hint">0 = å®Œå…¨ä¸ç—›ï¼Œ10 = ç”Ÿç”¢ç—›</div>
        </div>

        <div class="row">
          <label>æœ€ç—›æ™‚ç–¼ç—›ç¨‹åº¦ï¼ˆ0â€“10ï¼‰</label>
          <div class="slider-row">
            <input type="range" min="0" max="10" step="1" value="0" id="pain-max" data-field="painMax" />
            <span class="slider-value" id="pain-max-value">0</span>
          </div>
        </div>

        <div class="row">
          <label>å“ªäº›å‹•ä½œæˆ–æƒ…å¢ƒæœƒã€Œè®Šåš´é‡ã€ï¼Ÿï¼ˆå¯è¤‡é¸ï¼‰</label>
          <div class="chips" data-field="aggravating" data-type="multi">
            <button type="button" class="chip" data-value="ä¹…å">ä¹…å</button>
            <button type="button" class="chip" data-value="ä¹…ç«™">ä¹…ç«™</button>
            <button type="button" class="chip" data-value="å½è…°">å½è…°</button>
            <button type="button" class="chip" data-value="å¾Œä»°">å¾Œä»°</button>
            <button type="button" class="chip" data-value="æé‡ç‰©">æé‡ç‰©</button>
            <button type="button" class="chip" data-value="é‹å‹•æ™‚æˆ–é‹å‹•å¾Œ">é‹å‹•æ™‚ / é‹å‹•å¾Œ</button>
            <button type="button" class="chip" data-value="ç¡å‰">ç¡å‰</button>
            <button type="button" class="chip" data-value="ç¡é†’">ç¡é†’</button>
          </div>
        </div>

        <div class="row">
          <label>å“ªäº›äº‹æƒ…æœƒã€Œæ¯”è¼ƒèˆ’æœã€ï¼Ÿï¼ˆå¯è¤‡é¸ï¼‰</label>
          <div class="chips" data-field="easing" data-type="multi">
            <button type="button" class="chip" data-value="ä¼‘æ¯/èººè‘—">ä¼‘æ¯ / èººè‘—</button>
            <button type="button" class="chip" data-value="èµ°ä¸€èµ°/æ´»å‹•ä¸€ä¸‹">èµ°ä¸€èµ° / æ´»å‹•ä¸€ä¸‹</button>
            <button type="button" class="chip" data-value="åè‘—">åè‘—</button>
            <button type="button" class="chip" data-value="ç«™è‘—">ç«™è‘—</button>
            <button type="button" class="chip" data-value="ç†±æ•·">ç†±æ•·</button>
            <button type="button" class="chip" data-value="å†°æ•·">å†°æ•·</button>
            <button type="button" class="chip" data-value="åƒæ­¢ç—›è—¥">åƒæ­¢ç—›è—¥</button>
          </div>
        </div>

        <div class="divider"></div>

        <div class="section-title">
          éå»ç—…å²èˆ‡ç”¨è—¥
          <span>Medical History</span>
        </div>

        <div class="row">
          <label for="diseases">é‡å¤§ç–¾ç—… / æ…¢æ€§ç–¾ç—…</label>
          <textarea id="diseases" name="diseases" placeholder="ä¾‹ï¼šé«˜è¡€å£“ã€ç³–å°¿ç—…ã€ç”²ç‹€è…ºã€é¢¨æ¿•ã€å…ç–«ç›¸é—œç–¾ç—…â€¦" data-field></textarea>
        </div>

        <div class="row">
          <label for="surgery">æ‰‹è¡“æˆ–é‡å¤§å¤–å‚·å²</label>
          <textarea id="surgery" name="surgery" placeholder="ä¾‹ï¼šæ¤é–“ç›¤æ‰‹è¡“ã€éŸŒå¸¶é‡å»ºã€è»Šç¦å—å‚·â€¦" data-field></textarea>
        </div>

        <div class="row">
          <label for="meds">ç›®å‰æ­£åœ¨æœç”¨çš„è—¥ç‰©æˆ–è£œå……å“</label>
          <textarea id="meds" name="meds" placeholder="ä¾‹ï¼šæ­¢ç—›è—¥ã€è‚Œè‚‰é¬†å¼›åŠ‘ã€é¿å­•è—¥ã€é¡å›ºé†‡ã€æŠ—å‡è¡€è—¥â€¦" data-field></textarea>
          <div class="hint">æ­¤è³‡è¨Šåƒ…ä¾›æ²»ç™‚å®‰å…¨è©•ä¼°ï¼Œä¸æœƒå¤–æµã€‚</div>
        </div>

        <div class="divider"></div>

        <div class="section-title">
          ç”Ÿæ´»ç‹€æ…‹èˆ‡ç›®æ¨™
          <span>Function & Goals</span>
        </div>

        <div class="row">
          <label>ç¡çœ å“è³ª</label>
          <div class="pill-toggle-group" data-field="sleep" data-type="single">
            <button type="button" class="pill-toggle" data-value="å¾ˆå¥½">å¾ˆå¥½</button>
            <button type="button" class="pill-toggle" data-value="æ™®é€š">æ™®é€š</button>
            <button type="button" class="pill-toggle" data-value="åå·®">åå·®</button>
            <button type="button" class="pill-toggle" data-value="ç¶“å¸¸å¤±çœ /å¤šå¤¢">ç¶“å¸¸å¤±çœ  / å¤šå¤¢</button>
          </div>
        </div>

        <div class="row">
          <label>é‹å‹•ç¿’æ…£</label>
          <div class="pill-toggle-group" data-field="exercise" data-type="single">
            <button type="button" class="pill-toggle" data-value="å¹¾ä¹ä¸é‹å‹•">å¹¾ä¹ä¸é‹å‹•</button>
            <button type="button" class="pill-toggle" data-value="æ¯é€± 1â€“2 æ¬¡">æ¯é€± 1â€“2 æ¬¡</button>
            <button type="button" class="pill-toggle" data-value="æ¯é€± 3 æ¬¡ä»¥ä¸Š">æ¯é€± 3 æ¬¡ä»¥ä¸Š</button>
          </div>
        </div>

        <div class="row">
          <label for="goals">æœ¬æ¬¡ç‰©ç†æ²»ç™‚æœ€å¸Œæœ›é”æˆçš„ç›®æ¨™</label>
          <textarea id="goals" name="goals" placeholder="ä¾‹ï¼šå¯ä»¥ä¹…åè¾¦å…¬ 2 å°æ™‚ä¸ç—›ã€å¯ä»¥æ­£å¸¸è·‘æ­¥ã€å¯ä»¥æŠ±å°å­©â€¦" data-field></textarea>
        
        <div class="divider"></div>
        
    
        <div class="bottom-space"></div>
        <div class="sticky-footer">
          <div class="btn-row">
            <button type="button" class="btn btn-outline" id="btn-clear">
              æ¸…é™¤æš«å­˜
            </button>
            <button type="button" class="btn btn-primary" id="btn-goto-therapist">
              äº¤çµ¦æ²»ç™‚å¸«è©•ä¼° ğŸ©º
            </button>
          </div>
        </div>
      </div>
    </main>

    <!-- æ²»ç™‚å¸«è©•ä¼°é  -->
    <main id="page-therapist" class="page">
      <div class="card">
        <div class="section-title">
          å€‹æ¡ˆæ‘˜è¦
          <span>Client Summaryï¼ˆè®€å–å·¦å´è³‡æ–™ï¼‰</span>
        </div>
        <div id="summary-block">
          <div class="summary-row">
            <div class="summary-label">å§“å</div>
            <div class="summary-value" id="s-name">â€”</div>
          </div>
          <div class="summary-row">
            <div class="summary-label">å¹´é½¡ / æ€§åˆ¥</div>
            <div class="summary-value" id="s-age-gender">â€”</div>
          </div>
          <div class="summary-row">
            <div class="summary-label">è·æ¥­ / ç”Ÿæ´»å‹æ…‹</div>
            <div class="summary-value" id="s-job-life">
              <div class="pill-group" id="s-lifestyle"></div>
            </div>
          </div>
          <div class="summary-row">
            <div class="summary-label">ä¸»è¨´</div>
            <div class="summary-value" id="s-main">â€”</div>
          </div>
          <div class="summary-row">
            <div class="summary-label">ç—‡ç‹€</div>
            <div class="summary-value" id="s-pain">
              <div class="pill-group" id="s-pain-tags"></div>
            </div>
          </div>
          <div class="summary-row">
            <div class="summary-label">ç–¼ç—›ç¨‹åº¦</div>
            <div class="summary-value" id="s-pain-scale">â€”</div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="section-title">æœ¬æ¬¡è©•ä¼°æ™‚é–“è»¸</div>
<div id="pt-timeline"></div>
<div class="divider"></div>

        <div class="section-title">
          è§€å¯Ÿèˆ‡åŠŸèƒ½æ¸¬è©¦
          <span>Observation & Functional Tests</span>
        </div>

        <div class="grid-2">
          <div class="row">
            <label for="obs-posture">å§¿å‹¢è§€å¯Ÿ</label>
            <input id="obs-posture" type="text" placeholder="ä¾‹ï¼šé ­å‰å¼•ã€éª¨ç›†å‰å‚¾ã€èƒ¸æ¤å¾Œå‡¸â€¦" data-field-pt="obsPosture" />
          </div>
          <div class="row">
            <label for="obs-gait">æ­¥æ…‹ / åŠŸèƒ½</label>
            <input id="obs-gait" type="text" placeholder="ä¾‹ï¼šå³å´å–®è…³ç«™ä¸ç©©ã€å³æ­¥å¹…è¼ƒå°â€¦" data-field-pt="obsGait" />
          </div>
        </div>

        <div class="grid-2">
          <div class="row">
            <label for="tests-joint">é—œç¯€æ´»å‹•åº¦ / è‚Œè‚‰é•·åº¦æ¸¬è©¦</label>
            <input id="tests-joint" type="text" placeholder="ä¾‹ï¼šè…°æ¤å‰å½å—é™ï¼ŒFABER(R) ç‰½æ‰¯â€¦" data-field-pt="testsJoint" />
          </div>
          <div class="row">
            <label for="tests-nerve">ç¥ç¶“å¼µåŠ› / ç‰¹æ®Šæ¸¬è©¦</label>
            <input id="tests-nerve" type="text" placeholder="ä¾‹ï¼šSlumpï¼ˆRï¼‰+ï¼ŒSLR(R) 60Â° æ”¾å°„è‡³å°è…¿â€¦" data-field-pt="testsNerve" />
          </div>
        </div>

        <div class="row">
          <label for="soft-tissue">è»Ÿçµ„ç¹” / è§¸è¨º</label>
          <textarea id="soft-tissue" placeholder="ä¾‹ï¼šå³è‡€ä¸­è‚Œå£“ç—›æ˜é¡¯ã€è…¿å¾Œè‚Œç¾¤ç·Šç¹ƒã€æ¢¨ç‹€è‚Œå£“ç—›â€¦" data-field-pt="softTissue"></textarea>
        </div>

        <div class="divider"></div>

        <div class="section-title">
          è‡¨åºŠæ¨è«–
          <span>Clinical Reasoning</span>
        </div>

        <div class="row">
          <label>å¯èƒ½çš„ä¸»è¦å•é¡Œï¼ˆå¯é»é¸ï¼‹è‡ªè¡Œè£œå……ï¼‰</label>
          <div class="chips" data-field-pt="reasonTags" data-type="multi">
            <button type="button" class="chip" data-value="é—œç¯€æ´»å‹•å—é™">é—œç¯€æ´»å‹•å—é™</button>
            <button type="button" class="chip" data-value="é—œç¯€ç©©å®šåº¦ä¸è¶³">é—œç¯€ç©©å®šåº¦ä¸è¶³</button>
            <button type="button" class="chip" data-value="é—œç¯€è»Œé“ç•°å¸¸">é—œç¯€è»Œé“ç•°å¸¸</button>
            <button type="button" class="chip" data-value="è‚Œè‚‰ç¸®çŸ­">è‚Œè‚‰ç¸®çŸ­</button>
            <button type="button" class="chip" data-value="è‚Œè‚‰éé•·">è‚Œè‚‰éé•·</button>
            <button type="button" class="chip" data-value="è‚Œè‚‰é«˜å¼µ">è‚Œè‚‰é«˜å¼µ</button>
            <button type="button" class="chip" data-value="è‚Œè‚‰ä½å¼µ">è‚Œè‚‰é«˜å¼µ</button>
            <button type="button" class="chip" data-value="ç¥ç¶“é«˜å¼µ">ç¥ç¶“é«˜å¼µ</button>
            <button type="button" class="chip" data-value="å§¿å‹¢èˆ‡å‹•ä½œè² è·éé«˜">å§¿å‹¢èˆ‡å‹•ä½œè² è·éé«˜</button>
          </div>
        </div>

        <div class="row">
          <label for="reasoning">è‡¨åºŠæ¨è«–æ‘˜è¦</label>
          <textarea id="reasoning" placeholder="ä¾‹ï¼šæ¨æ¸¬ä»¥ç¥ç¶“å¼µåŠ›èˆ‡è² è·æ•æ„Ÿç‚ºä¸»ï¼Œæ—©æœŸç”±è–¦é«‚ç—›è½‰ç‚ºè…¿å¾Œæ‹‰æ‰¯èˆ‡è¶³éƒ¨éº»æœ¨â€¦" data-field-pt="reasoning"></textarea>
        </div>

        <div class="divider"></div>

        <div class="section-title">
          æ²»ç™‚è¨ˆç•«èˆ‡å»ºè­°
          <span>Treatment Plan</span>
        </div>

        <div class="row">
          <label>æœ¬æœŸç›®æ¨™ï¼ˆå¯è¤‡é¸ï¼‰</label>
          <div class="chips" data-field-pt="planGoals" data-type="multi">
            <button type="button" class="chip" data-value="é™ä½ç–¼ç—›">é™ä½ç–¼ç—›</button>
            <button type="button" class="chip" data-value="æ”¹å–„ç”Ÿæ´»åŠŸèƒ½">æ”¹å–„ç”Ÿæ´»åŠŸèƒ½</button>
            <button type="button" class="chip" data-value="å¢åŠ æŸ”è»Ÿåº¦">å¢åŠ æŸ”è»Ÿåº¦</button>
            <button type="button" class="chip" data-value="æå‡æ§åˆ¶èƒ½åŠ›">æå‡æ§åˆ¶èƒ½åŠ›</button>
            <button type="button" class="chip" data-value="æå‡è‚ŒåŠ›">æå‡è‚ŒåŠ›</button>
          </div>
        </div>

        <div class="row">
          <label for="treatment-plan">ä»Šæ—¥æ²»ç™‚å…§å®¹</label>
          <textarea id="treatment-plan" placeholder="ä¾‹ï¼š1. éª¨ç›†èˆ‡è…°æ¤é—œç¯€é¬†å‹• 2. åéª¨ç¥ç¶“é¬†å‹•æ»‘å‹• 3. è…¿å¾Œè‚Œä¼¸å±•æ•™è‚²â€¦" data-field-pt="treatmentPlan"></textarea>
        </div>

        <div class="row">
          <label for="home-ex">å±…å®¶é‹å‹•èˆ‡æ³¨æ„äº‹é …</label>
          <textarea id="home-ex" placeholder="ä¾‹ï¼šæ¯æ—¥ 3 æ¬¡ç¥ç¶“é¬†å‹•ã€å°å¹…åº¦è…¿å¾Œä¼¸å±•ï¼Œé¿å…ä¹…åè¶…é 30â€“40 åˆ†é˜â€¦" data-field-pt="homeEx"></textarea>
        </div>

        <div class="row">
          <label for="follow-up">ä¸‹æ¬¡è¿½è¹¤é‡é»</label>
          <textarea id="follow-up" placeholder="ä¾‹ï¼šè§€å¯Ÿéº»æœ¨é »ç‡è®ŠåŒ–ã€ä¹…åè€å—åº¦ã€Slump æ¸¬è©¦è®ŠåŒ–â€¦" data-field-pt="followUp"></textarea>
        
        <div class="divider"></div>
        <div class="section-title">ç–¼ç—›è¶¨å‹¢</div>
        <canvas id="vas-chart" height="180"></canvas>
    
        <div class="bottom-space"></div>
        <div class="sticky-footer">
          <div class="btn-row">
            <button type="button" class="btn btn-outline" id="btn-back-client">
              å›åˆ°å€‹æ¡ˆå¡«å¯«
            </button>
            <button type="button" id="btn-mark-done" class="btn btn-success">å®Œæˆæœ¬æ¬¡è©•ä¼° âœ“</button>
          </div>
        </div>
      </div>
    </main>
<!-- ç¬¬ä¸‰é ï¼šå€‹æ¡ˆç®¡ç† -->
<main id="page-cases" class="page">
  <div class="card">
    <div class="section-title">å€‹æ¡ˆç®¡ç†</div>
    <div class="row">
      <input id="case-search" type="text" placeholder="æœå°‹å§“åæˆ–ä¸»è¨´â€¦" 
             style="width:100%;padding:9px 10px;border-radius:999px;border:1px solid #d1d5db;font-size:0.9rem;">
    </div>
    <div id="case-count" class="hint" style="margin-top:6px;">å…± 0 ç­†å€‹æ¡ˆ</div>
    <div id="case-list" 
         style="margin-top:12px;border-radius:12px;border:1px solid #e5e7eb;max-height:60vh;overflow-y:auto;">
    </div>

    <div style="margin-top:14px; display:flex; gap:8px;">
      <button id="btn-import-all" class="btn btn-outline" style="flex:1;">
        åŒ¯å…¥å€‹æ¡ˆè³‡æ–™åº«
      </button>
      
      <button id="btn-export-all" class="btn btn-primary" style="flex:1;">
        åŒ¯å‡ºå€‹æ¡ˆè³‡æ–™åº«
      </button>

      <input type="file" id="import-file" accept="application/json" style="display:none;" />
    </div>

  </div>
</main>

  </div>

  <script>
    
  const SUPABASE_URL = "https://yvacvzulhaaehffbhttt.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl2YWN2enVsaGFhZWhmZmJodHR0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4OTg1ODUsImV4cCI6MjA4MTQ3NDU4NX0.6tgcZoxClNCn9y5lft_H1XF2pfQGPb6beehSuQLEMD0";
  
  const sb = window.supabase.createClient(
    SUPABASE_URL,
    SUPABASE_ANON_KEY
  );
    
(() => {

  const authScreen = document.getElementById("auth-screen");
  const appRoot   = document.getElementById("app-root");
  const emailInput = document.getElementById("auth-email");
  const pwInput    = document.getElementById("auth-password");
  const authError  = document.getElementById("auth-error");
  const tabLogin   = document.getElementById("tab-login");
  const tabSignup  = document.getElementById("tab-signup");
  const btnAuth    = document.getElementById("btn-auth-submit");
  const btnLogout  = document.getElementById("btn-logout");

  let authMode = "login"; // login | signup

  function setAuthMode(mode){
    authMode = mode;
    if (mode === "login"){
      tabLogin.classList.add("active");
      tabSignup.classList.remove("active");
      btnAuth.textContent = "ç™»å…¥";
    } else {
      tabSignup.classList.add("active");
      tabLogin.classList.remove("active");
      btnAuth.textContent = "è¨»å†Š";
    }
    authError.textContent = "";
  }

  function showApp(){
    if (!appRoot || !authScreen) return;
    authScreen.classList.add("hidden");
    appRoot.classList.remove("hidden");
  }

  function showLogin(){
    if (!appRoot || !authScreen) return;
    appRoot.classList.add("hidden");
    authScreen.classList.remove("hidden");
  }

  async function handleAuthSubmit(){
    if (!sb){
      alert("Supabase å°šæœªè¨­å®šï¼Œè«‹å…ˆè¨­å®š URL èˆ‡ Keyã€‚");
      return;
    }
    const email = (emailInput?.value || "").trim();
    const password = pwInput?.value || "";
    authError.textContent = "";
    if (!email || !password){
      authError.textContent = "è«‹è¼¸å…¥ Email èˆ‡å¯†ç¢¼ã€‚";
      return;
    }

    try{
      if (authMode === "login"){
        const { data, error } = await sb.auth.signInWithPassword({ email, password });
        if (error) throw error;

        const ok = await guardRoleOrBlock();
        if (!ok) return;
      
        clearLocalDraft();

        showApp();
        
        await syncPatientsFromSupabase();
        subscribePatientsRealtime();
      }else{
        const { data, error } = await sb.auth.signUp({ email, password });
        if (error) throw error;
      
        const user = data.user;
        if (!user){
          throw new Error("ä½¿ç”¨è€…å»ºç«‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
        }
      
        // â¬‡â¬‡â¬‡ã€æ–°å¢ï¼šå»ºç«‹ profilesã€‘
        const { error: profileError } = await sb
          .from("profiles")
          .insert({
            user_id: user.id,
            email: user.email,
            role: "pending",
          });
      
        if (profileError){
          throw profileError;
        }
      
        // â¬‡â¬‡â¬‡ã€é‡è¦ï¼šç¢ºä¿ä¸æ®˜ç•™ç™»å…¥ç‹€æ…‹ã€‘
        await sb.auth.signOut();
      
        alert("è¨»å†ŠæˆåŠŸï¼\n\nè«‹è¯çµ¡ PhysioNotes å®˜æ–¹é–‹é€šæ¬Šé™å¾Œå†ç™»å…¥ã€‚");
        pwInput.value = "";
      }

    }catch(err){
      console.error(err);
      authError.textContent = err.message || "ç™»å…¥ / è¨»å†Šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
    }
  }

  async function initAuthOnLoad(){
    const session = await sb.auth.getSession();
    if (!session?.data?.session) {
      showLogin();
      return;
    }
    if (!sb){
      // æ²’è¨­å®š Supabase å°±ç›´æ¥é¡¯ç¤ºä¸»ç•«é¢ï¼Œé¿å…æ•´å€‹ç³»çµ±ç„¡æ³•ä½¿ç”¨
      showApp();
      return;
    }
    try{
      const { data, error } = await sb.auth.getSession();
      if (error) throw error;
      if (data && data.session){

        const ok = await guardRoleOrBlock();
        if (!ok) return;
        showApp();
        await syncPatientsFromSupabase();
        subscribePatientsRealtime();
      }else{
        showLogin();
      }
    }catch(err){
      console.error(err);
      showLogin();
    }
  }

  // ç¶å®š Auth ç›¸é—œäº‹ä»¶
  if (tabLogin && tabSignup && btnAuth){
    tabLogin.addEventListener("click", () => setAuthMode("login"));
    tabSignup.addEventListener("click", () => setAuthMode("signup"));
    btnAuth.addEventListener("click", handleAuthSubmit);
    pwInput?.addEventListener("keydown", (e)=>{
      if (e.key === "Enter") handleAuthSubmit();
    });
  }

  if (btnLogout){
    btnLogout.addEventListener("click", async () => {
      if (sb){
        clearLocalDraft()
        await sb.auth.signOut();
      }
      showLogin();
    });
  }

  // åˆå§‹åŒ–ç‹€æ…‹
  setAuthMode("login");
  initAuthOnLoad();

  const STORAGE = {
    client: "pt_eval_client_v1",
    therapist: "pt_eval_therapist_v1",
    library: "pt_eval_case_library_v1",
    visit: "pt_eval_visit_v1",
    currentCaseId: "pt_eval_current_case_id_v1",
    currentRecordIndex: "pt_eval_current_record_idx_v1"
  };

  const $  = (s, r=document)=>r.querySelector(s);
  const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));
  const parse = (s,f)=>{try{return JSON.parse(s??"")??f}catch{return f}};
  const now = ()=>Date.now();

  
  function collectFullCase() {
    return {
      client: localStorage.getItem("pt_eval_client_v1"),
      therapist: localStorage.getItem("pt_eval_therapist_v1"),
      visit: localStorage.getItem("pt_eval_visit_v1"),
      caseLibrary: localStorage.getItem("pt_eval_case_library_v1"),
      currentRecordIndex: localStorage.getItem("pt_eval_current_record_idx_v1"),
  
      // VAS slider
      vasMin: localStorage.getItem("vasMin"),
      vasMax: localStorage.getItem("vasMax"),
  
      // ä½ ä¹‹å¾Œå…¶ä»–æ¬„ä½ä¾åºè£œä¸Š
    }
  }

  const loadClient    = ()=>parse(localStorage.getItem(STORAGE.client),{});
  const saveClient = (d)=>{
    localStorage.setItem(STORAGE.client, JSON.stringify(d||{}));
  };
  const loadTherapist = ()=>parse(localStorage.getItem(STORAGE.therapist),{});
  const saveTherapist = (d)=>{
    localStorage.setItem(STORAGE.therapist, JSON.stringify(d||{}));
  };
  const loadVisit     = ()=>parse(localStorage.getItem(STORAGE.visit),{ vasNow:null, vasMax:null });
  const saveVisit = (d)=>{
    localStorage.setItem(STORAGE.visit, JSON.stringify(d||{}));
  };
  const resetVisit    = ()=>saveVisit({ vasNow:null, vasMax:null });

  async function syncCaseToSupabase() {
    if (!sb) return;
  
    const { data: userResult } = await sb.auth.getUser();
    if (!userResult?.user) return;
    const userId = userResult.user.id;
  
    const client = loadClient();
    const visit = loadVisit();
    const therapist = loadTherapist();
  
    if (!client.name) return;
  
    let patientId = null;
    const currentCaseId = getCurrentCaseId();
  
    // âœ… 1ï¸âƒ£ å·²å­˜åœ¨çš„ Supabase ç—…äºº
    if (currentCaseId && currentCaseId.startsWith("sb_")) {
      patientId = currentCaseId.replace("sb_", "");
    }
  
    // âœ… 2ï¸âƒ£ å¦‚æœæ²’æœ‰ï¼Œæ‰å»ºç«‹æ–° patient
    if (!patientId) {
      const { data: newPatient, error } = await sb
        .from("patients")
        .insert({
          user_id: userId,
          name: client.name,
          age: client.age,
          gender: client.gender,
          job: client.job,
          main_complaint: client.mainComplaint,
          raw_client: client
        })
        .select()
        .single();
  
      if (error) {
        alert(error.message);
        return;
      }
  
      patientId = newPatient.id;
      setCurrentCaseId(`sb_${patientId}`);
    }
  
    // âœ… 3ï¸âƒ£ æ°¸é åªæ–°å¢ visitï¼ˆç™‚ç¨‹ï¼‰
    const { error: vErr } = await sb.from("visit").insert({
      user_id: userId,
      patient_id: patientId,
      vas_now: visit.vasNow,
      vas_max: visit.vasMax,
      raw_visit: visit,
      raw_therapist: therapist
    });
  
    if (vErr) {
      alert(vErr.message);
      return;
    }
  
    console.log("âœ… æ–°å¢ä¸€ç­†ç™‚ç¨‹æˆåŠŸ", patientId);
  }

    //  Supabase Realtimeï¼šå³æ™‚åŒæ­¥å€‹æ¡ˆåˆ—è¡¨
  let patientChannel = null;
  
  async function subscribePatientsRealtime() {
    // ç¢ºä¿å·²ç™»å…¥
    const { data } = await sb.auth.getSession();
    if (!data?.session) return;
  
    // é¿å…é‡è¤‡è¨‚é–±
    if (patientChannel) {
      sb.removeChannel(patientChannel);
    }
  
    patientChannel = sb
      .channel("patients-realtime")
      .on(
        "postgres_changes",
        {
          event: "*",           // INSERT / UPDATE / DELETE
          schema: "public",
          table: "patients",
        },
        async (payload) => {
          console.log("ğŸ”„ Supabase patients è®Šæ›´", payload);
  
          // â­ é‡é»ï¼šé‡æ–°å¾ Supabase æ‹‰ä¸€æ¬¡è³‡æ–™
          await syncPatientsFromSupabase();
        }
      )
      .subscribe();
  }
  
  async function deleteCaseFromSupabase(caseId){
    if (!sb) return;
  
    // âœ… æ¯æ¬¡è‡ªå·±é‡æ–°æ‹¿ userï¼ˆä¸è¦ä¾è³´å¤–éƒ¨è®Šæ•¸ï¼‰
    const { data: userResult, error } = await sb.auth.getUser();
    if (error || !userResult?.user) {
      alert("å°šæœªç™»å…¥ï¼Œç„¡æ³•åˆªé™¤");
      return;
    }
  
    const userId = userResult.user.id;
  
    // è™•ç† sb_ å‰ç¶´
    const realId = String(caseId).startsWith("sb_")
      ? caseId.replace("sb_", "")
      : caseId;
  
    const { error: delErr } = await sb
      .from("patients")
      .delete()
      .eq("id", realId)
      .eq("user_id", userId);
  
    if (delErr) {
      console.error(delErr);
      alert("åˆªé™¤å¤±æ•—ï¼š" + delErr.message);
      return;
    }
  
    console.log("âœ… Supabase å€‹æ¡ˆå·²åˆªé™¤", realId);
  }

  const loadLib = ()=>parse(localStorage.getItem(STORAGE.library),{});
  const saveLib = (d)=>localStorage.setItem(STORAGE.library,JSON.stringify(d||{}));

  async function syncPatientsFromSupabase() {
    const { data: userResult } = await sb.auth.getUser();
    if (!userResult?.user) return;
  
    const userId = userResult.user.id;
  
    const { data, error } = await sb
      .from("patients")
      .select(`
        *,
        visit (
          id,
          vas_now,
          vas_max,
          raw_visit,
          raw_therapist,
          created_at
        )
      `)
      .eq("user_id", userId)
      .order("created_at", { ascending: false });
  
    if (error) {
      console.error("âŒ æ‹‰ patients å¤±æ•—", error);
      return;
    }
  
    const lib = {};
  
    data.forEach((p) => {
      const caseId = `sb_${p.id}`;
  
      lib[caseId] = {
        client: p.raw_client || {},
        records: (p.visit || []).map(v => ({
          therapist: v.raw_therapist || {},
          visit: {
            vasNow: v.vas_now,
            vasMax: v.vas_max
          },
          status: "done",
          createdAt: new Date(v.created_at).getTime(),
          updatedAt: new Date(v.created_at).getTime()
        }))
      };
    });
  
    // â­ å­˜å› localStorageï¼ˆä½ åŸæœ¬çš„è³‡æ–™çµæ§‹ï¼‰
    saveLib(lib);
  
    // â­ æ›´æ–°ç•«é¢
    renderCaseList();
  }

  function clearLocalDraft() {
    localStorage.removeItem(STORAGE.client);
    localStorage.removeItem(STORAGE.therapist);
    localStorage.removeItem(STORAGE.visit);
    setCurrentCaseId(null);
    setCurrentRecordIndex(0);
    resetVisit();
    renderClientUI({});
    renderTherapistUI({});
    renderSummary();
  }

  async function getMyRole(){
    if (!sb) return null;
  
    const { data: userResult } = await sb.auth.getUser();
    const user = userResult?.user;
    if (!user) return null;
  
    const { data, error } = await sb
      .from("profiles")
      .select("role")
      .eq("user_id", user.id)
      .maybeSingle();
  
    if (error) {
      console.error("è®€å– profiles å¤±æ•—", error);
      return null;
    }
    return data?.role ?? null;
  }
  
  async function guardRoleOrBlock(){
    const role = await getMyRole();
  
    // æ²’æœ‰ role ä¹Ÿå…ˆæ“‹ï¼ˆé€šå¸¸æ˜¯ profiles/RLS/trigger æ²’å¼„å¥½ï¼‰
    if (!role) {
      alert("æ­¤å¸³è™Ÿå°šæœªå»ºç«‹æ¬Šé™è³‡æ–™ã€‚");
      await sb.auth.signOut();
      showLogin();
      return false;
    }
  
    if (role === "pending") {
      alert("ä½ çš„å¸³è™Ÿæ­£åœ¨ç­‰å¾…é–‹é€šã€‚\nè«‹è¯çµ¡ç®¡ç†è€…é–‹é€šæ¬Šé™ã€‚");
      await sb.auth.signOut();
      showLogin();
      return false;
    }
  
    // therapist / admin æ‰æ”¾è¡Œ
    return true;
  }

  const getCurrentCaseId = ()=>localStorage.getItem(STORAGE.currentCaseId);
  const setCurrentCaseId = (id)=> id ? localStorage.setItem(STORAGE.currentCaseId,id) : localStorage.removeItem(STORAGE.currentCaseId);

  const getCurrentRecordIndex = ()=>{
    const v = localStorage.getItem(STORAGE.currentRecordIndex);
    return v==null ? 0 : Math.max(0, parseInt(v,10) || 0);
  };
  const setCurrentRecordIndex = (i)=> localStorage.setItem(STORAGE.currentRecordIndex, String(Math.max(0, i|0)));

  const pages = {
    client:   ()=>$("#page-client"),
    therapist:()=>$("#page-therapist"),
    cases:    ()=>$("#page-cases")
  };

  const warn = (v)=> (v==null || (Array.isArray(v)&&v.length===0) || (typeof v==="string" && v.trim()===""))
    ? "<span class='warn'>âš  æœªå¡«</span>" : v;

  const ensureCaseShape = (item)=>{
    if(!item) return null;
    if(item.records) return item;
    return {
      client: item.client||{},
      records: [{
        therapist: item.therapist||{},
        status: item.status || "draft",
        createdAt: item.createdAt || now(),
        updatedAt: item.updatedAt || now(),
        visit: item.visit || { vasNow:null, vasMax:null }
      }]
    };
  };

  const collectClient = ()=>{
    const r = pages.client(), d = {};
    $$("[data-field]", r).forEach(el=>{
      if(el.tagName==="INPUT" && el.type==="range") return; // VAS å­˜åˆ° visit
      const k = el.name || el.id; if(!k) return;
      d[k] = (el.type==="number" ? (el.value===""?null:Number(el.value)) : (el.value??"").toString());
    });

    $$(".pill-toggle-group[data-field]", r).forEach(g=>{
      const k = g.getAttribute("data-field");
      const a = g.querySelector(".pill-toggle.active");
      d[k] = a ? a.getAttribute("data-value") : null;
    });

    $$(".chips[data-field]", r).forEach(w=>{
      const k = w.getAttribute("data-field");
      d[k] = $$(".chip.selected", w).map(c=>c.getAttribute("data-value"));
    });

    d.name = (d.name||"").trim();
    d.mainComplaint = (d.mainComplaint||"").trim();
    return d;
  };

  const collectTherapist = ()=>{
    const r = pages.therapist(), d = {};
    $$("[data-field-pt]", r).forEach(el=>{
      const k = el.getAttribute("data-field-pt"); if(!k) return;
      d[k] = (el.type==="number" ? (el.value===""?null:Number(el.value)) : (el.value??"").toString());
    });
    $$(".chips[data-field-pt]", r).forEach(w=>{
      const k = w.getAttribute("data-field-pt");
      d[k] = $$(".chip.selected", w).map(c=>c.getAttribute("data-value"));
    });
    return d;
  };

  const collectVisitFromSliders = ()=>{
    const v = loadVisit();
    return { vasNow: v.vasNow, vasMax: v.vasMax };
  };

  const resetClientUI = ()=>{
    const r = pages.client();
    $$("input[type=text],input[type=number],textarea", r).forEach(el=>el.value="");
    $$(".pill-toggle.active", r).forEach(el=>el.classList.remove("active"));
    $$(".chip.selected", r).forEach(el=>el.classList.remove("selected"));
    if($("#pain-now")) { $("#pain-now").value="0"; $("#pain-now-value") && ($("#pain-now-value").textContent="0"); }
    if($("#pain-max")) { $("#pain-max").value="0"; $("#pain-max-value") && ($("#pain-max-value").textContent="0"); }
  };

  const resetTherapistUI = ()=>{
    const r = pages.therapist();
    $$("input[type=text],input[type=number],textarea", r).forEach(el=>el.value="");
    $$(".chip.selected", r).forEach(el=>el.classList.remove("selected"));
  };

  const renderClientUI = (d)=>{
    d=d||{};
    resetClientUI();
    
    const r = pages.client();

    $$("[data-field]", r).forEach(el=>{
      if(el.tagName==="INPUT" && el.type==="range") return;
      const k = el.name || el.id; if(!k) return;
      el.value = (d[k]==null ? "" : String(d[k]));
    });

    $$(".pill-toggle-group[data-field]", r).forEach(g=>{
      const k = g.getAttribute("data-field");
      const v = d[k];
      $$(".pill-toggle", g).forEach(b=>b.classList.toggle("active", b.getAttribute("data-value")===v));
    });

    $$(".chips[data-field]", r).forEach(w=>{
      const k = w.getAttribute("data-field");
      const set = new Set(d[k]||[]);
      $$(".chip", w).forEach(c=>c.classList.toggle("selected", set.has(c.getAttribute("data-value"))));
    });

    const visit = loadVisit();
    if($("#pain-now")) { $("#pain-now").value = String(visit.vasNow ?? 0); $("#pain-now-value") && ($("#pain-now-value").textContent = String(visit.vasNow ?? 0)); }
    if($("#pain-max")) { $("#pain-max").value = String(visit.vasMax ?? 0); $("#pain-max-value") && ($("#pain-max-value").textContent = String(visit.vasMax ?? 0)); }
  };

  const renderTherapistUI = (d)=>{
    d=d||{};
    resetTherapistUI();
    const r = pages.therapist();
    $$("[data-field-pt]", r).forEach(el=>{
      const k = el.getAttribute("data-field-pt"); if(!k) return;
      el.value = (d[k]==null ? "" : String(d[k]));
    });
    $$(".chips[data-field-pt]", r).forEach(w=>{
      const k = w.getAttribute("data-field-pt");
      const set = new Set(d[k]||[]);
      $$(".chip", w).forEach(c=>c.classList.toggle("selected", set.has(c.getAttribute("data-value"))));
    });
  };

  const renderSummary = ()=>{
    const c = loadClient();
    const visit = loadVisit();

    $("#s-name").innerHTML = c.name?.trim()?c.name:"<span class='warn'>âš  æœªå¡«</span>";
    const age = Number.isFinite(c.age)?c.age:null;
    $("#s-age-gender").innerHTML = `${warn(age)} / ${warn(c.gender)}`;

    const life=$("#s-lifestyle"); life.innerHTML="";
    const job=(c.job||"").trim();
    if(job){const s=document.createElement("span");s.className="pill-ghost";s.textContent=job;life.appendChild(s)}
    (c.lifestyle||[]).forEach(v=>{const s=document.createElement("span");s.className="pill-ghost";s.textContent=v;life.appendChild(s)});
    if(!job && (c.lifestyle||[]).length===0) life.innerHTML="<span class='warn'>âš  æœªå¡«</span>";

    $("#s-main").innerHTML = c.mainComplaint?.trim()?c.mainComplaint:"<span class='warn'>âš  æœªå¡«</span>";

    const pain=$("#s-pain-tags"); pain.innerHTML="";
    (c.painTypes||[]).forEach(v=>{const s=document.createElement("span");s.className="pill-ghost";s.textContent=v;pain.appendChild(s)});
    if((c.painTypes||[]).length===0) pain.innerHTML="<span class='warn'>âš  æœªå¡«</span>";

    const nowv = visit.vasNow;
    const maxv = visit.vasMax;
    $("#s-pain-scale").innerHTML = (nowv==null && maxv==null)
      ? "<span class='warn'>âš  æœªå¡«</span>"
      : `${nowv ?? "â€”"} / ${maxv ?? "â€”"}`;
  };

  const switchTab = (key)=>{
    $$(".tab-btn").forEach(b=>{
      b.classList.toggle("active", b.getAttribute("data-target")===`page-${key}`);
    });
    Object.keys(pages).forEach(k=>{
      pages[k]()?.classList.toggle("active", k===key);
    });
    if(key==="cases") renderCaseList();
    if(key==="therapist") { renderSummary(); requestAnimationFrame(()=>{ try{ renderVasChart(); }catch(e){} }); }
  };
  window.switchTab = switchTab;

  const openCase = (caseId)=>{
    const lib = loadLib();
    const item = ensureCaseShape(lib[caseId]);
    if(!item) return;

    setCurrentCaseId(caseId);

    const idx = Math.max(0, (item.records?.length||1) - 1);
    setCurrentRecordIndex(idx);

    saveClient(item.client||{});
    const visit = item.records[idx]?.visit || { vasNow:null, vasMax:null };
    saveVisit({ vasNow: visit.vasNow ?? null, vasMax: visit.vasMax ?? null });

    saveTherapist(item.records[idx]?.therapist||{});

    renderClientUI(loadClient());
    renderTherapistUI(loadTherapist());
    renderTimeline(item);
    switchTab("client");
  };

  const createNewCaseFromCurrent = ()=>{
    const c = collectClient();
    if(!c.name){ alert("è«‹è‡³å°‘å¡«å¯«å§“å"); return null; }

    const id = `case_${now()}_${(c.name||"case").replace(/\s+/g,"_")}`;
    const item = {
      client: c,
      records: [{
        therapist: collectTherapist(),
        visit: collectVisitFromSliders(),
        status: "draft",
        createdAt: now(),
        updatedAt: now()
      }]
    };

    const lib = loadLib();
    lib[id] = item;
    saveLib(lib);
    setCurrentCaseId(id);
    setCurrentRecordIndex(0);
    return { id, item };
  };

  const upsertCurrentCaseAndRecord = ({markDone=false}={})=>{
    const visit = loadVisit();
    if(visit.vasNow == null){
      alert("è«‹å€‹æ¡ˆå…ˆå¡«å¯«ã€Œç›®å‰ç–¼ç—›ç¨‹åº¦ï¼ˆVASï¼‰ã€");
      switchTab("client");
      return null;
    }
    if(visit.vasMax == null){
      alert("è«‹å€‹æ¡ˆå…ˆå¡«å¯«ã€Œæœ€ç—›æ™‚ç–¼ç—›ç¨‹åº¦ï¼ˆVASï¼‰ã€");
      switchTab("client");
      return null;
    }

    const caseId = getCurrentCaseId();
    const lib = loadLib();

    if(!caseId || !lib[caseId]){
      const created = createNewCaseFromCurrent();
      if(!created) return null;
      if(markDone){
        created.item.records[0].status="done";
        created.item.records[0].updatedAt=now();
        lib[created.id]=created.item;
        saveLib(lib);
      }
      return { caseId: created.id, item: created.item, recordIndex: 0 };
    }

    const item = ensureCaseShape(lib[caseId]);
    item.client = collectClient();

    const idx = getCurrentRecordIndex();
    const safeIdx = Math.min(Math.max(0, idx), (item.records.length-1));
    setCurrentRecordIndex(safeIdx);

    item.records[safeIdx] = item.records[safeIdx] || { therapist:{}, visit:{}, status:"draft", createdAt:now(), updatedAt:now() };
    item.records[safeIdx].therapist = collectTherapist();
    item.records[safeIdx].visit = collectVisitFromSliders();
    item.records[safeIdx].updatedAt = now();
    if(markDone) item.records[safeIdx].status = "done";

    lib[caseId] = item;
    saveLib(lib);

    return { caseId, item, recordIndex: safeIdx };
  };

  const addNewRecordForCurrentCase = ()=>{
    const caseId = getCurrentCaseId();
    if(!caseId){
      alert("è«‹å…ˆå¾ã€Œå€‹æ¡ˆç®¡ç†ã€é¸æ“‡ä¸€ä½å€‹æ¡ˆï¼Œå†æ–°å¢å›è¨ºç´€éŒ„ã€‚");
      switchTab("cases");
      return;
    }
    const lib = loadLib();
    const item = ensureCaseShape(lib[caseId]);
    if(!item) return;

    const last = item.records[item.records.length-1] || { therapist:{} };
    item.records.push({
      therapist: { ...(last.therapist||{}) },
      visit: { vasNow:null, vasMax:null },
      status: "draft",
      createdAt: now(),
      updatedAt: now()
    });

    lib[caseId]=item;
    saveLib(lib);

    const idx = item.records.length-1;
    setCurrentRecordIndex(idx);

    resetVisit();
    saveTherapist(item.records[idx].therapist||{});
    renderClientUI(loadClient());
    renderTherapistUI(loadTherapist());
    renderTimeline(item);
    switchTab("client");
    alert("å·²å»ºç«‹æ–°å›è¨ºç´€éŒ„ï¼Œè«‹å€‹æ¡ˆé‡æ–°å¡«å¯« VASã€‚");
  };
  
function clearVasChart(){
  const cvs=document.getElementById("vas-chart");
  if(!cvs) return;
  const ctx=cvs.getContext("2d");
  ctx.clearRect(0,0,cvs.width,cvs.height);
}

function renderVasChart() {

  const cvs = document.getElementById("vas-chart");
  if (!cvs) return;

  const ctx = cvs.getContext("2d");

  // ===== width & height real size =====
  const W = cvs.width = (cvs.clientWidth || (cvs.parentElement ? cvs.parentElement.clientWidth : 0) || 320);

  const H = cvs.height || 180;  // canvas çœŸæ­£ç¹ªè£½é«˜åº¦
  ctx.clearRect(0, 0, W, H);

  const caseId = getCurrentCaseId();
  if (!caseId) return;

  const lib = loadLib();
  const item = ensureCaseShape(lib[caseId]);
  if (!item || !item.records) return;

  const N = item.records.length;

  // === extract: visit index + vas now + vas max ===
  const points = item.records
    .map((r, i) => ({
      idx: i + 1,
      vasNow: (r.visit && r.visit.vasNow != null) ? Number(r.visit.vasNow) : null,
      vasMax: (r.visit && r.visit.vasMax != null) ? Number(r.visit.vasMax) : null,
    }))
    .filter(p => p.vasNow != null || p.vasMax != null);

  if (points.length < 1) return;

  // --- ä¸‹é¢é€™æ®µé–‹å§‹æ‰é€²å…¥ä½ çš„ç¹ªè£½ ---

  const padL=36, padR=14, padT=14, padB=60;
  const plotW = W - padL - padR;
  const plotH = H - padT - padB;
  if(plotW<=0 || plotH<=0) return;

  // Axes: Y (VAS) left, X (visit #) bottom
  ctx.strokeStyle="#94a3b8";
  ctx.lineWidth=1;
  ctx.beginPath();
  ctx.moveTo(padL,padT);
  ctx.lineTo(padL,H-padB);
  ctx.lineTo(W-padR,H-padB);
  ctx.stroke();

  ctx.fillStyle="#475569";
  ctx.font="12px sans-serif";

  // Y ticks: VAS 0/5/10 (bottom->top)
  [0,5,10].forEach(v=>{
    const y = (H-padB) - plotH*(v/10);
    ctx.beginPath(); ctx.moveTo(padL-4,y); ctx.lineTo(padL,y); ctx.stroke();
    ctx.fillText(String(v), 8, y+4);
  });

  // X ticks: visit index 1..N (left->right)
  let step=1;
  if(N>20) step=5;
  else if(N>10) step=2;

  for(let i=1;i<=N;i+=step){
    const x = padL + plotW*((i-1)/(Math.max(1,N-1)));
    ctx.beginPath(); ctx.moveTo(x,H-padB); ctx.lineTo(x,H-padB+4); ctx.stroke();
    ctx.fillText(String(i), x-3, H-padB+16);
  }
  if(N>1 && ((N-1) % step) !== 0){
    const x = padL + plotW;
    ctx.beginPath(); ctx.moveTo(x,H-padB); ctx.lineTo(x,H-padB+4); ctx.stroke();
    ctx.fillText(String(N), x-3, H-padB+16);
  }
  
  // ---- åœ–ä¾‹ ----
  const legendY = H - padB + 33; // åœ¨ Xè»¸ä¸‹æ–¹ä¸€é»é«˜åº¦
  
  ctx.font="13px sans-serif";
  
  // ç¬¬ä¸€åˆ—ï¼šè—
  ctx.fillStyle="#2563eb";
  ctx.fillText("ç›®å‰ç–¼ç—›ï¼ˆè—ï¼‰", padL, legendY);
  
  // ç¬¬äºŒåˆ—ï¼šç´…
  ctx.fillStyle="#dc2626";
  ctx.fillText("æœ€å¤§ç–¼ç—›ï¼ˆç´…ï¼‰", padL, legendY + 20);

  // ---- ç•«ç›®å‰ç–¼ç—›ç·š (è—) ----
  ctx.strokeStyle="#2563eb";
  ctx.lineWidth=2;
  ctx.beginPath();
  points.forEach((p,i)=>{
    if(p.vasNow==null) return;
    const x = padL + plotW*((p.idx-1)/(Math.max(1,N-1)));
    const y = (H-padB) - plotH*(p.vasNow/10);
    i ? ctx.lineTo(x,y) : ctx.moveTo(x,y);
  });
  ctx.stroke();
  
  // ---- ç•«æœ€å¤§ç–¼ç—› (ç´…) ----
  ctx.strokeStyle="#dc2626";
  ctx.lineWidth=2;
  ctx.beginPath();
  points.forEach((p,i)=>{
    if(p.vasMax==null) return;
    const x = padL + plotW*((p.idx-1)/(Math.max(1,N-1)));
    const y = (H-padB) - plotH*(p.vasMax/10);
    i ? ctx.lineTo(x,y) : ctx.moveTo(x,y);
  });
  ctx.stroke();

  // ---- dots: VAS ç›®å‰ç–¼ç—› (è—é») ----
  ctx.fillStyle="#2563eb";
  points.forEach(p=>{
    if(p.vasNow==null) return;
    const x = padL + plotW*((p.idx-1)/(Math.max(1,N-1)));
    const y = (H-padB) - plotH*(p.vasNow/10);
    ctx.beginPath(); ctx.arc(x,y,4,0,Math.PI*2); ctx.fill();
  });
  
  // ---- dots: VAS æœ€å¤§ç–¼ç—› (ç´…é») ----
  ctx.fillStyle="#dc2626";
  points.forEach(p=>{
    if(p.vasMax==null) return;
    const x = padL + plotW*((p.idx-1)/(Math.max(1,N-1)));
    const y = (H-padB) - plotH*(p.vasMax/10);
    ctx.beginPath(); ctx.arc(x,y,4,0,Math.PI*2); ctx.fill();
  });

}
    
  const renderTimeline = (item)=>{
    const wrap = $("#pt-timeline");
    if(!wrap) return;
    wrap.innerHTML = "";
    const recs = item.records || [];
    const idx = getCurrentRecordIndex();

    const tl = document.createElement("div");
    tl.className = "timeline";

    recs.forEach((r,i)=>{
      const chip = document.createElement("div");
      chip.className = "t-chip" + (i===idx ? " active" : "");
      chip.textContent = `ç¬¬ ${i+1} æ¬¡`;
      chip.onclick = ()=>{
        setCurrentRecordIndex(i);
        saveTherapist(r.therapist||{});
        saveVisit(r.visit||{ vasNow:null, vasMax:null });
        renderTherapistUI(loadTherapist());
        renderClientUI(loadClient());
        renderTimeline(item);
        renderSummary();
        renderVasChart();
      };
      tl.appendChild(chip);
    });

    const addBtn = document.createElement("button");
    addBtn.type="button";
    addBtn.className="btn btn-outline";
    addBtn.textContent="+ æ–°å¢ä¸€æ¬¡è©•ä¼°";
    addBtn.onclick = addNewRecordForCurrentCase;

    wrap.appendChild(tl);
    wrap.appendChild(addBtn);
  };

  const deleteCase = async (caseId)=>{
    if(!confirm("ç¢ºå®šè¦åˆªé™¤æ­¤å€‹æ¡ˆï¼Ÿï¼ˆæ­¤å‹•ä½œä¸å¯å¾©åŸï¼‰")) return;
  
    try{
      // â­ å…ˆåˆª Supabase
      await deleteCaseFromSupabase(caseId);
  
      // â­ å†åˆª localStorage
      const lib = loadLib();
      delete lib[caseId];
      saveLib(lib);
  
      if(getCurrentCaseId()===caseId){
        setCurrentCaseId(null);
        setCurrentRecordIndex(0);
      }
  
      renderCaseList();
  
    }catch(e){
      console.error(e);
    }
  };

  const renderCaseList = ()=>{
    const list = $("#case-list");
    const cnt  = $("#case-count");
    const q    = $("#case-search");
    if(!list || !cnt || !q) return;

    const lib = loadLib();
    const keys = Object.keys(lib);

    const kw = (q.value||"").trim();
    const ids = kw ? keys.filter(id=>{
      const it = ensureCaseShape(lib[id]);
      const c = it?.client||{};
      const last = it?.records?.[it.records.length-1] || {};
      const vas = last.visit?.vasNow;
      return (c.name||"").includes(kw) || (c.mainComplaint||"").includes(kw) || String(vas ?? "").includes(kw);
    }) : keys;

    cnt.textContent = `å…± ${ids.length} ç­†å€‹æ¡ˆ`;
    list.innerHTML = "";

    ids.forEach(id=>{
      const it = ensureCaseShape(lib[id]);
      if(!it) return;
      const c = it.client||{};
      const last = it.records[it.records.length-1] || {};
      const vasNow = last.visit?.vasNow;

      const row = document.createElement("div");
      row.className = "case-row";

      const main = document.createElement("div");
      main.className = "case-main";
      const nm = document.createElement("div");
      nm.className="case-name";
      const ageText = (c.age==null || c.age==="") ? "?" : c.age;
      nm.textContent = c.name ? `${c.name} | ${ageText}æ­²` : "(ç„¡å§“å)";
      main.appendChild(nm);

      const mid = document.createElement("div");
      mid.className="case-mid";
      mid.textContent = `${c.mainComplaint || "ç„¡ä¸»è¨´"} | ${(vasNow==null) ? "VAS: -" : `VAS: ${vasNow}/10`}`;

      const visitBadge = document.createElement("div");
      visitBadge.className="pill";
      visitBadge.textContent = `ç¬¬ ${it.records.length} æ¬¡`;

      const actions = document.createElement("div");
      actions.className="case-actions";
      const del = document.createElement("button");
      del.type="button";
      del.className="btn-icon btn-danger";
      del.title="åˆªé™¤";
      del.innerHTML = `<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M9 3h6l1 2h5v2H3V5h5l1-2zm1 7h2v8h-2v-8zm4 0h2v8h-2v-8zM7 10h2v8H7v-8z"/></svg>`;
      del.onclick = (e)=>{ e.stopPropagation(); deleteCase(id); };
      actions.appendChild(del);

      row.appendChild(main);
      row.appendChild(mid);
      row.appendChild(visitBadge);
      row.appendChild(actions);

      row.onclick = ()=> openCase(id);

      list.appendChild(row);
    });

    // normalize back to library
    const normalized = {};
    Object.keys(lib).forEach(id=>{
      normalized[id] = ensureCaseShape(lib[id]) || lib[id];
    });
    saveLib(normalized);
  };

  const bind = ()=>{
    // tabs
    $$(".tab-btn").forEach(b=>{
      b.addEventListener("click", ()=> switchTab((b.getAttribute("data-target")||"page-client").replace("page-","")));
    });

    // pill toggles
    document.addEventListener("click", (e)=>{
      const btn = e.target.closest(".pill-toggle");
      if(!btn) return;
      const group = btn.closest(".pill-toggle-group");
      if(!group) return;
      $$(".pill-toggle", group).forEach(x=>x.classList.remove("active"));
      btn.classList.add("active");
      saveClient(collectClient());
      renderSummary();
    });

    // chips multi
    document.addEventListener("click", (e)=>{
      const chip = e.target.closest(".chip");
      if(!chip) return;
      const wrap = chip.closest(".chips");
      if(!wrap) return;
      chip.classList.toggle("selected");
      if(wrap.hasAttribute("data-field-pt")) saveTherapist(collectTherapist());
      else saveClient(collectClient());
      renderSummary();
    });

    // VAS sliders
    const pn=$("#pain-now");
    const pm=$("#pain-max");
    pn && pn.addEventListener("input", ()=>{
      $("#pain-now-value") && ($("#pain-now-value").textContent = pn.value);
      const v = loadVisit();
      v.vasNow = Number(pn.value);
      saveVisit(v);
      renderSummary();
      // ğŸ”¹ å³æ™‚åŒæ­¥åˆ°å€‹æ¡ˆåº«ï¼ˆå¦‚æœå·²æœ‰å€‹æ¡ˆï¼‰
      const caseId = getCurrentCaseId();
      if (caseId) {
        const lib = loadLib();
        const item = ensureCaseShape(lib[caseId]);
        const idx = getCurrentRecordIndex();
        if (item && item.records[idx]) {
          item.records[idx].visit = loadVisit();
          item.records[idx].updatedAt = Date.now();
          lib[caseId] = item;
          saveLib(lib);
        }
      }

    });
    pm && pm.addEventListener("input", ()=>{
      $("#pain-max-value") && ($("#pain-max-value").textContent = pm.value);
      const v = loadVisit();
      v.vasMax = Number(pm.value);
      saveVisit(v);
      renderSummary();
    });

    // clear cache
    $("#btn-clear") && $("#btn-clear").addEventListener("click", ()=>{
      if(!confirm("ç¢ºå®šè¦æ¸…é™¤æš«å­˜ï¼Ÿ")) return;
      localStorage.removeItem(STORAGE.client);
      localStorage.removeItem(STORAGE.therapist);
      localStorage.removeItem(STORAGE.visit);
      setCurrentCaseId(null);
      setCurrentRecordIndex(0);
      resetVisit();
      renderClientUI({});
      renderTherapistUI({});
      renderSummary();
    });

   // client -> therapist
    $("#btn-goto-therapist") && $("#btn-goto-therapist").addEventListener("click", ()=>{
      // å…ˆæŠŠç•«é¢ä¸Šçš„å…§å®¹å­˜é€²æš«å­˜
      saveClient(collectClient());
      saveVisit(collectVisitFromSliders());
      saveTherapist(collectTherapist());

      // é—œéµï¼šé€™ä¸€æ­¥æœƒæŠŠã€Œç›®å‰é€™æ¬¡è©•ä¼°ã€å¯«å› records[] è£¡
      const res = upsertCurrentCaseAndRecord({ markDone:false });
      if(!res) {
        // upsert å…§éƒ¨å·²ç¶“æœƒå¹«ä½ è·³å› client ä¸¦ alert ç¼ºå°‘ VAS çš„æƒ…æ³
        return;
      }

      // ç”¨æœ€æ–°å¯«å›å»çš„ item ä¾†æ›´æ–° timeline / åœ–è¡¨
      const item = res.item;

      renderSummary();
      renderVasChart();
      renderTimeline(item);

      // æœ€å¾Œå†åˆ‡æ›åˆ°æ²»ç™‚å¸«è©•ä¼°é 
      switchTab("therapist");
    });

    // therapist -> client
    $("#btn-back-client") && $("#btn-back-client").addEventListener("click", ()=>{
      renderClientUI(loadClient());
      switchTab("client");
    });

    // å®Œæˆæœ¬æ¬¡è©•ä¼° = å„²å­˜ï¼ˆæ–°æ¡ˆå»ºç«‹ / èˆŠæ¡ˆæ›´æ–°ä¸æ–°å¢å€‹æ¡ˆï¼‰+ done
    $("#btn-mark-done") && $("#btn-mark-done").addEventListener("click", async ()=>{
      // 1ï¸âƒ£ å…ˆæŠŠç•«é¢è³‡æ–™å­˜é€² localStorage
      saveTherapist(collectTherapist());
    
      // 2ï¸âƒ£ æ›´æ–°æœ¬åœ° caseï¼ˆä½ çš„åŸé‚è¼¯ï¼‰
      const res = upsertCurrentCaseAndRecord({ markDone:true });
      if(!res) return;
    
      renderTimeline(res.item);
      renderVasChart();
      renderCaseList();
    
      // 3ï¸âƒ£ â­åªæœ‰é€™è£¡æ‰åŒæ­¥ Supabase
      await syncCaseToSupabase();
    
      alert("å®Œæˆæœ¬æ¬¡è©•ä¼°ï¼Œä¸¦å·²åŒæ­¥åˆ°é›²ç«¯è³‡æ–™åº«");
      switchTab("cases");
    });

    // search
    $("#case-search") && $("#case-search").addEventListener("input", renderCaseList);
  };

  document.addEventListener("DOMContentLoaded", ()=>{
    bind();

    // åˆå§‹åŒ–ï¼šå¦‚æœ visit ä¸å­˜åœ¨ï¼Œå…ˆè¨­ç‚º nullï¼ˆé€¼æ¯æ¬¡éƒ½è¦å¡« VASï¼‰
    if(!localStorage.getItem(STORAGE.visit)) resetVisit();

    renderClientUI(loadClient());
    renderTherapistUI(loadTherapist());
    renderSummary();
    renderCaseList();
    switchTab("client");
  });
    // ==== æ‰¹é‡åŒ¯å‡ºå…¨éƒ¨å€‹æ¡ˆ ====
document.getElementById("btn-export-all")?.addEventListener("click", ()=>{
  const lib = loadLib();          // æ‰€æœ‰å€‹æ¡ˆ
  const blob = new Blob(
    [ JSON.stringify(lib,null,2) ],
    { type: "application/json;charset=utf-8" }
  );

  const a = document.createElement("a");
  const dt = new Date().toISOString().slice(0,10);
  a.href = URL.createObjectURL(blob);
  a.download = `cases_list_${dt}.json`;
  a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href),2000);

  alert("å·²åŒ¯å‡ºå€‹æ¡ˆè³‡æ–™åº«");
});


// ==== æ‰¹é‡åŒ¯å…¥å…¨éƒ¨å€‹æ¡ˆ ====
document.getElementById("btn-import-all")?.addEventListener("click",()=>{
  document.getElementById("import-file").click();
});

document.getElementById("import-file")?.addEventListener("change",(e)=>{
  const f = e.target.files?.[0];
  if(!f) return;

  const reader = new FileReader();
  reader.onload = ()=>{
    try{
      const obj = JSON.parse(reader.result);

      if(typeof obj !== "object"){
        alert("æ ¼å¼éŒ¯èª¤ï¼Œéœ€ç‚º JSON æ ¼å¼");
        return;
      }

      saveLib(obj);        
      
      setCurrentCaseId(null);              // âœ¨ reset é¸å–çš„å€‹æ¡ˆ
      setCurrentRecordIndex(0);            // âœ¨ reset è©•ä¼°æ¬¡æ•¸
      resetVisit();                        // âœ¨ reset VAS æš«å­˜
      saveClient({});                      // âœ¨ æ¸…ç©º client
      saveTherapist({});                   // âœ¨ æ¸…ç©º therapist
      
      alert("åŒ¯å…¥å®Œæˆâœ” å·²æ›´æ–°å€‹æ¡ˆåˆ—è¡¨");

      renderCaseList();                    // âœ¨æ›´æ–° UI
      renderClientUI({});                  // âœ¨å¼·åˆ¶åˆ·æ–°ç¬¬ä¸€é 
      renderTherapistUI({});               
      renderSummary();

    }catch(err){
      console.error(err);
      alert("åŒ¯å…¥å¤±æ•—ï¼šéåˆæ³•JSON");
    }
    document.getElementById("importFile").value = null;
  };
  reader.readAsText(f);
});

})();

</script>
</body>
</html>
