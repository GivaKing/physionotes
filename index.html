<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" href="/logo.ico" type="image/x-icon">
  <title>PhysioNotes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <style>
    :root {
      --primary: #2563eb;
      --primary-soft: #dbeafe;
      --bg: #f3f4f6;
      --card: #ffffff;
      --border: #e5e7eb;
      --text: #111827;
      --muted: #6b7280;
      --danger: #dc2626;
      --success: #16a34a;
      --accent: #0ea5e9;
      --radius-lg: 16px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
    }

    .hidden {
      display: none !important;
    }

    .app {
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px;
    }

    header {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
      gap: 12px;
    }

    header .title {
      font-size: 20px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    header .badge {
      font-size: 12px;
      padding: 2px 8px;
      border-radius: 999px;
      background: #e0f2fe;
      color: #0369a1;
    }

    header .subtitle {
      font-size: 13px;
      color: #6b7280;
      margin-top: 2px;
    }

    header .status-text {
      font-size: 12px;
      color: #4b5563;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    header .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.2);
    }

    .tabs {
      display: flex;
      border-radius: 999px;
      background: #e5e7eb;
      padding: 4px;
      width: 100%;
      max-width: 420px;
    }

    .tab-btn {
      flex: 1;
      border: none;
      background: transparent;
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 14px;
      font-weight: 500;
      color: #4b5563;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      transition: background 0.15s ease, color 0.15s ease, box-shadow 0.15s ease;
    }

    .tab-btn .icon {
      font-size: 16px;
    }

    .tab-btn.active {
      background: #ffffff;
      color: var(--primary);
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }

    main {
      display: grid;
      grid-template-columns: minmax(0, 7fr) minmax(0, 5fr);
      gap: 16px;
    }

    @media (max-width: 960px) {
      main {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .card {
      background: var(--card);
      border-radius: var(--radius-lg);
      padding: 16px;
      box-shadow: 0 1px 3px rgba(15,23,42,0.06);
      border: 1px solid var(--border);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      gap: 8px;
    }

    .card-title {
      font-size: 15px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .card-title .emoji {
      font-size: 18px;
    }

    .card-subtitle {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 12px;
    }

    .field-group {
      margin-bottom: 12px;
    }

    .field-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 8px;
    }

    .field-label {
      font-size: 13px;
      color: #4b5563;
      flex: 0 0 auto;
      min-width: 56px;
      font-weight: 500;
    }

    .field-hint {
      font-size: 11px;
      color: #9ca3af;
      margin-top: 2px;
    }

    input[type="text"],
    input[type="number"],
    textarea,
    select {
      width: 100%;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      font-size: 14px;
      outline: none;
      transition: border-color 0.15s ease, box-shadow 0.15s ease;
      background: #f9fafb;
    }

    textarea {
      min-height: 60px;
      resize: vertical;
    }

    input[type="text"]:focus,
    input[type="number"]:focus,
    textarea:focus,
    select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.1);
      background: #ffffff;
    }

    .chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .chip {
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      color: #4b5563;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: background 0.15s ease, color 0.15s ease, border-color 0.15s ease, box-shadow 0.15s ease;
    }

    .chip .dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #e5e7eb;
    }

    .chip.active {
      background: #dbeafe;
      color: #1d4ed8;
      border-color: #93c5fd;
      box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.4);
    }

    .chip.active .dot {
      background: #3b82f6;
    }

    .chip.small {
      padding: 3px 8px;
      font-size: 11px;
    }

    .section-title {
      font-size: 13px;
      font-weight: 600;
      margin: 12px 0 4px;
      color: #374151;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .section-title .pill {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      background: #eff6ff;
      color: #1d4ed8;
    }

    .human-map {
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 8px 0;
    }

    .human-canvas {
      width: 160px;
      max-width: 100%;
      height: auto;
      cursor: pointer;
    }

    .human-legend {
      font-size: 11px;
      color: #6b7280;
      text-align: center;
      margin-top: 4px;
    }

    .summary-list {
      list-style: none;
      padding: 0;
      margin: 0;
      font-size: 13px;
    }

    .summary-item {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding: 6px 0;
      border-bottom: 1px dashed #e5e7eb;
      gap: 8px;
    }

    .summary-label {
      color: #6b7280;
      min-width: 72px;
      flex: 0 0 auto;
    }

    .summary-value {
      flex: 1;
      text-align: right;
      color: #111827;
    }

    .summary-empty {
      color: #9ca3af;
      font-style: italic;
    }

    .summary-warning {
      color: #b91c1c;
      font-style: normal;
      font-weight: 500;
    }

    .summary-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      border-radius: 999px;
      background: #ecfdf3;
      color: #166534;
      font-size: 11px;
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 12px;
    }

    button {
      font-family: inherit;
    }

    .btn-primary {
      border: none;
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 13px;
      font-weight: 500;
      color: #ffffff;
      background: #22c55e;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 1px 2px rgba(22, 163, 74, 0.3);
      transition: background 0.15s ease, transform 0.05s ease, box-shadow 0.15s ease;
    }

    .btn-primary:hover {
      background: #15803d;
      box-shadow: 0 2px 5px rgba(22, 163, 74, 0.4);
    }

    .btn-primary:active {
      transform: translateY(1px);
      box-shadow: 0 1px 2px rgba(22, 163, 74, 0.3);
    }

    .btn-secondary {
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 13px;
      color: #374151;
      border: 1px solid #d1d5db;
      background: #ffffff;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: background 0.15s ease, color 0.15s ease, border-color 0.15s ease, box-shadow 0.15s ease;
    }

    .btn-secondary:hover {
      background: #f9fafb;
      border-color: #cbd5e1;
      box-shadow: 0 1px 2px rgba(15, 23, 42, 0.08);
    }

    .btn-danger {
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 12px;
      color: #ffffff;
      border: 1px solid #fecaca;
      background: #ef4444;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition: background 0.15s ease, box-shadow 0.15s ease;
    }

    .btn-danger:hover {
      background: #b91c1c;
      box-shadow: 0 1px 3px rgba(248, 113, 113, 0.6);
    }

    .btn-pill-small {
      border-radius: 999px;
      padding: 4px 8px;
      font-size: 11px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      color: #4b5563;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition: background 0.15s ease, border-color 0.15s ease, color 0.15s ease;
    }

    .btn-pill-small:hover {
      background: #eff6ff;
      border-color: #bfdbfe;
      color: #1d4ed8;
    }

    .section-divider {
      border: none;
      border-top: 1px dashed #e5e7eb;
      margin: 12px 0;
    }

    .pill-label {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      background: #f3f4f6;
      color: #6b7280;
    }

    .small-label {
      font-size: 11px;
      color: #6b7280;
    }

    .tag-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid #e5e7eb;
      color: #4b5563;
      background: #f9fafb;
      margin-right: 4px;
      margin-bottom: 4px;
    }

    .tag-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #c4b5fd;
    }

    .tag-dot.green {
      background: #86efac;
    }

    .tag-dot.red {
      background: #fca5a5;
    }

    .tag-dot.blue {
      background: #93c5fd;
    }

    .tag-dot.yellow {
      background: #facc15;
    }

    .pt-section {
      background: #f9fafb;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px dashed #e5e7eb;
      margin-top: 6px;
    }

    .pt-section-title {
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 6px;
      color: #374151;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .pt-section-title .pill {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      background: #fefce8;
      color: #854d0e;
    }

    .pt-section-body {
      font-size: 12px;
      color: #4b5563;
      line-height: 1.5;
    }

    .readonly-text {
      white-space: pre-wrap;
      background: #f9fafb;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px dashed #e5e7eb;
      font-size: 12px;
    }

    .check-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      font-size: 13px;
      margin-top: 4px;
    }

    .check-item {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .check-item input {
      width: 14px;
      height: 14px;
    }

    .small-input {
      width: 60px;
      padding: 4px 6px;
      font-size: 12px;
      border-radius: 6px;
    }

    .slider-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 4px;
    }

    .slider-row input[type="range"] {
      flex: 1;
    }

    .slider-value {
      min-width: 18px;
      text-align: right;
      font-size: 13px;
      font-weight: 600;
      color: #111827;
    }

    .small-note {
      font-size: 11px;
      color: #9ca3af;
      margin-top: 2px;
    }

    .case-list-container {
      max-height: 420px;
      overflow-y: auto;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
    }

    .case-list-item {
      padding: 8px 10px;
      border-bottom: 1px solid #e5e7eb;
      cursor: pointer;
      display: grid;
      grid-template-columns: minmax(0, 4fr) minmax(0, 6fr) minmax(0, 3fr);
      align-items: center;
      column-gap: 8px;
      row-gap: 4px;
      font-size: 13px;
      background: #ffffff;
      transition: background 0.12s ease;
    }

    .case-list-item:nth-child(even) {
      background: #f9fafb;
    }

    .case-list-item:hover {
      background: #eff6ff;
    }

    .case-name {
      font-weight: 600;
      color: #111827;
      min-width: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .case-main {
      font-size: 12px;
      color: #374151;
      min-width: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .case-visit {
      font-size: 12px;
      color: #4b5563;
      text-align: right;
    }

    .case-visit strong {
      color: #111827;
    }

    .case-list-empty {
      font-size: 13px;
      color: #9ca3af;
      padding: 12px;
      text-align: center;
    }

    .case-list-header {
      display: grid;
      grid-template-columns: minmax(0, 4fr) minmax(0, 6fr) minmax(0, 3fr);
      align-items: center;
      column-gap: 8px;
      padding: 6px 10px;
      font-size: 11px;
      color: #6b7280;
      border-bottom: 1px solid #e5e7eb;
      background: #f3f4f6;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    .case-list-header span {
      font-weight: 500;
    }

    .case-search-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    .case-search-row input[type="text"] {
      flex: 1;
      padding: 6px 10px;
      font-size: 13px;
      border-radius: 999px;
    }

    .case-count {
      font-size: 11px;
      color: #6b7280;
    }

    .case-import-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 6px;
      margin-top: 10px;
      font-size: 11px;
      color: #6b7280;
    }

    .case-import-row .btn-pill-small {
      font-size: 11px;
      padding: 4px 8px;
    }

    .case-import-row code {
      background: #e5e7eb;
      border-radius: 4px;
      padding: 0 4px;
      font-size: 10px;
    }

    .summary-visit {
      font-size: 12px;
      color: #4b5563;
      margin-top: 4px;
    }

    .summary-visit strong {
      color: #111827;
    }

    .vas-chart-wrapper {
      margin-top: 12px;
      border-radius: 12px;
      border: 1px dashed #e5e7eb;
      padding: 10px 12px;
      background: #f9fafb;
      display: none;
    }

    .vas-chart-title {
      font-size: 12px;
      font-weight: 600;
      color: #374151;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .vas-chart-title .pill {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      background: #eff6ff;
      color: #1d4ed8;
    }

    .vas-chart-hint {
      font-size: 11px;
      color: #6b7280;
      margin-bottom: 6px;
    }

    .vas-chart-canvas-wrap {
      width: 100%;
      overflow: hidden;
    }

    #vas-chart {
      width: 100%;
      height: 180px;
      display: block;
    }

    .tag-row {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 6px;
    }

    .tag-row .tag-badge {
      margin-right: 0;
      margin-bottom: 0;
    }

    .login-screen {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at top, #eff6ff 0, #e5e7eb 40%, #d1d5db 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 50;
    }

    .login-card {
      width: 100%;
      max-width: 360px;
      padding: 24px 20px 20px;
      background: #ffffff;
      border-radius: 16px;
      box-shadow:
        0 10px 40px rgba(15, 23, 42, 0.25),
        0 0 0 1px rgba(148, 163, 184, 0.5);
      border: 1px solid #e5e7eb;
    }

    .login-title {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 4px;
      color: #111827;
    }

    .login-subtitle {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 16px;
    }

    .login-label {
      font-size: 13px;
      display: block;
      margin-bottom: 4px;
    }

    .login-input {
      width: 100%;
      padding: 10px 12px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      font-size: 14px;
      margin-bottom: 12px;
    }

    .login-input:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.2);
    }

    .login-btn {
      width: 100%;
      border-radius: 999px;
      padding: 9px 0;
      border: none;
      background: #2563eb;
      color: #ffffff;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
      transition: background 0.15s ease, transform 0.05s ease, box-shadow 0.15s ease;
    }

    .login-btn:hover {
      background: #1d4ed8;
      box-shadow: 0 6px 20px rgba(37, 99, 235, 0.6);
    }

    .login-btn:active {
      transform: translateY(1px);
      box-shadow: 0 3px 8px rgba(37, 99, 235, 0.5);
    }

    .logout-btn {
      margin-left: 12px;
      padding: 4px 12px;
      border-radius: 999px;
      border: 1px solid #d4d4d8;
      background: #ffffff;
      font-size: 12px;
      color: #4b5563;
      cursor: pointer;
    }

    .logout-btn:hover {
      background: #f3f4f6;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

</head>
<body>
  <!-- ç™»å…¥ç•«é¢ -->
  <div id="login-screen" class="login-screen">
    <div class="login-card">
      <div class="login-title">PhysioNotes ç™»å…¥</div>
      <div class="login-subtitle">è«‹è¼¸å…¥å¸³è™Ÿèˆ‡å¯†ç¢¼é€²å…¥å€‹æ¡ˆç³»çµ±ã€‚</div>
      <label class="login-label" for="login-email">å¸³è™Ÿï¼ˆEmailï¼‰</label>
      <input id="login-email" type="email" class="login-input" autocomplete="email" />
      <label class="login-label" for="login-password">å¯†ç¢¼</label>
      <input id="login-password" type="password" class="login-input" autocomplete="current-password" />
      <button id="btn-login" class="login-btn" type="button">ç™»å…¥</button>
    </div>
  </div>

  <!-- ä¸»ç³»çµ± -->
  <div id="app-root" class="app hidden">
    <header>
      <div class="title">
        PhysioNotes
        <span class="badge">ç¶²é ç‰ˆ</span>
      </div>
      <div class="subtitle">è«‹å…ˆå¡«å¯«å€‹æ¡ˆå•è¨ºè³‡æ–™ï¼Œå†é€²å…¥æ²»ç™‚å¸«è©•ä¼°é ã€‚</div>
      <div class="status-text">
        <span class="status-dot"></span> è‡ªå‹•æš«å­˜ä¸­
        <button id="btn-logout" class="logout-btn" type="button">ç™»å‡º</button>
      </div>
      <div class="tabs">
        <button class="tab-btn active" data-target="page-client">
          <span class="icon">ğŸ“</span>
          å€‹æ¡ˆå¡«å¯«
        </button>
        <button class="tab-btn" data-target="page-therapist">
          <span class="icon">ğŸ©º</span>
          æ²»ç™‚å¸«è©•ä¼°
        </button>
        <button class="tab-btn" data-target="page-cases">
          <span class="icon">ğŸ“‚</span>
          å€‹æ¡ˆç®¡ç†
        </button>
      </div>
    </header>

    <main>
      <!-- å€‹æ¡ˆå¡«å¯«é  -->
      <section id="page-client" class="card">
        <div class="card-header">
          <div>
            <div class="card-title">
              <span class="emoji">ğŸ§‘â€âš•ï¸</span>
              å€‹æ¡ˆå•è¨ºè³‡æ–™
            </div>
            <div class="card-subtitle">é€™ä¸€é ç”±å€‹æ¡ˆè‡ªè¡Œå¡«å¯«ï¼Œæ²»ç™‚å¸«å¯åœ¨ä¸‹ä¸€é çœ‹åˆ°æ‘˜è¦ã€‚</div>
          </div>
        </div>

        <div class="field-group">
          <div class="field-row">
            <div class="field-label">å§“å</div>
            <input id="c-name" type="text" placeholder="è«‹è¼¸å…¥å§“å" />
          </div>
          <div class="field-row">
            <div class="field-label">å¹´é½¡</div>
            <input id="c-age" type="number" min="0" max="120" placeholder="æ­²" style="max-width: 120px;" />
          </div>
          <div class="field-row">
            <div class="field-label">æ€§åˆ¥</div>
            <div class="chip-row" data-group="gender">
              <button type="button" class="chip" data-value="ç”·">ç”·</button>
              <button type="button" class="chip" data-value="å¥³">å¥³</button>
              <button type="button" class="chip" data-value="å…¶ä»–">å…¶ä»–</button>
            </div>
          </div>
          <div class="field-row">
            <div class="field-label">æ…£ç”¨æ‰‹</div>
            <div class="chip-row" data-group="handedness">
              <button type="button" class="chip" data-value="å³æ‰‹">å³æ‰‹</button>
              <button type="button" class="chip" data-value="å·¦æ‰‹">å·¦æ‰‹</button>
              <button type="button" class="chip" data-value="é›™æ‰‹çš†å¯">é›™æ‰‹çš†å¯</button>
            </div>
          </div>
          <div class="field-row">
            <div class="field-label">ä¸»è¦ç”Ÿæ´»å‹æ…‹</div>
            <div class="chip-row" data-group="lifestyle">
              <button type="button" class="chip" data-value="ä¹…å">ä¹…å</button>
              <button type="button" class="chip" data-value="ä¹…ç«™">ä¹…ç«™</button>
              <button type="button" class="chip" data-value="éœ€æ¬é‡ç‰©">éœ€æ¬é‡ç‰©</button>
              <button type="button" class="chip" data-value="éœ€ä¹…èµ°è·¯">éœ€ä¹…èµ°è·¯</button>
              <button type="button" class="chip" data-value="ç…§é¡§å®¶äºº/å°å­©">ç…§é¡§å®¶äºº/å°å­©</button>
            </div>
          </div>
        </div>

        <hr class="section-divider" />

        <div class="section-title">
          ç›®å‰ä¸»è¨´
          <span class="pill">ç–¼ç—›ä½ç½®ã€å‹æ…‹ã€å½±éŸ¿æ´»å‹•</span>
        </div>

        <div class="human-map">
          <img id="body-map" class="human-canvas" src="https://cdn.jsdelivr.net/gh/physionotes-assets/body-outline-front-back.png" alt="äººé«”ç¤ºæ„åœ–" />
        </div>
        <div class="human-legend">è«‹é»é¸å¸¸è¦‹ç–¼ç—›å€åŸŸæŒ‰éˆ•ï¼Œæˆ–åœ¨ä¸‹æ–¹æ–‡å­—å€è£œå……æè¿°ã€‚</div>

        <div class="field-group">
          <div class="field-row">
            <div class="field-label">ç–¼ç—›éƒ¨ä½</div>
            <div class="chip-row" data-group="pain-area">
              <button type="button" class="chip" data-value="é ¸éƒ¨">é ¸éƒ¨</button>
              <button type="button" class="chip" data-value="è‚©è†€">è‚©è†€</button>
              <button type="button" class="chip" data-value="ä¸ŠèƒŒ">ä¸ŠèƒŒ</button>
              <button type="button" class="chip" data-value="ä¸‹èƒŒ">ä¸‹èƒŒ</button>
              <button type="button" class="chip" data-value="é«–éƒ¨">é«–éƒ¨</button>
              <button type="button" class="chip" data-value="è†è“‹">è†è“‹</button>
              <button type="button" class="chip" data-value="è…³è¸">è…³è¸</button>
            </div>
          </div>
          <div class="field-row">
            <div class="field-label">ä¸»è¨´å…§å®¹</div>
            <textarea id="c-main-complaint" placeholder="ä¾‹ï¼šå³å´ä¸‹èƒŒæŒçºŒç— ç—›å…©é€±ï¼Œä¹…åè¶…é30åˆ†é˜æœƒåŠ åŠ‡ï¼Œå¾€å‰å½æ™‚æœ€æ˜é¡¯ã€‚"></textarea>
          </div>
          <div class="field-row">
            <div class="field-label">ç–¼ç—›å‹æ…‹</div>
            <div class="chip-row" data-group="pain-quality">
              <button type="button" class="chip" data-value="ç— ç—›">ç— ç—›</button>
              <button type="button" class="chip" data-value="åˆºç—›">åˆºç—›</button>
              <button type="button" class="chip" data-value="éº»æœ¨">éº»æœ¨</button>
              <button type="button" class="chip" data-value="è„¹ç—›">è„¹ç—›</button>
              <button type="button" class="chip" data-value="ç·Šç¹ƒ">ç·Šç¹ƒ</button>
              <button type="button" class="chip" data-value="è·³ç—›">è·³ç—›</button>
            </div>
          </div>
          <div class="field-row">
            <div class="field-label">èª˜ç™¼å‹•ä½œ</div>
            <textarea id="c-aggravating" placeholder="ä¾‹ï¼šä¹…åã€ä¹…ç«™ã€ä¹…èµ°ã€è·‘æ­¥ã€æé‡ç‰©ã€ä¹…ä½é ­æ»‘æ‰‹æ©Ÿã€è½‰èº«ã€å’³å—½..."></textarea>
          </div>
          <div class="field-row">
            <div class="field-label">ç·©è§£æ–¹å¼</div>
            <textarea id="c-relieving" placeholder="ä¾‹ï¼šç†±æ•·ã€èººå¹³ã€ä¼‘æ¯ã€ä¼¸å±•ã€è²¼è—¥å¸ƒ..."></textarea>
          </div>
        </div>

        <hr class="section-divider" />

        <div class="section-title">
          ç–¼ç—›åˆ†æ•¸ï¼ˆVASï¼‰
          <span class="pill">0 åˆ†ä¸ç—›ï¼Œ10 åˆ†ç‚ºæœ€ç—›</span>
        </div>

        <div class="field-group">
          <div class="field-row">
            <div class="field-label">ç›®å‰ç–¼ç—›</div>
            <div class="slider-row">
              <input id="vas-now" type="range" min="0" max="10" step="1" />
              <div class="slider-value" id="vas-now-value">0</div>
            </div>
            <div class="small-note">è«‹å°‡æ»‘æ¡¿æ‹‰åˆ°ç›®å‰æœ€è²¼è¿‘çš„ç–¼ç—›ç¨‹åº¦ã€‚</div>
          </div>
          <div class="field-row">
            <div class="field-label">æœ€ç—›æ›¾é”</div>
            <div class="slider-row">
              <input id="vas-max" type="range" min="0" max="10" step="1" />
              <div class="slider-value" id="vas-max-value">0</div>
            </div>
            <div class="small-note">å›æƒ³é€™æ¬¡ç—‡ç‹€ç™¼ä½œä»¥ä¾†ï¼Œæœ€ç—›æ›¾ç¶“é”åˆ°å¹¾åˆ†ã€‚</div>
          </div>
        </div>

        <hr class="section-divider" />

        <div class="section-title">
          ç”Ÿæ´»èˆ‡å·¥ä½œ
          <span class="pill">æ–¹ä¾¿æ²»ç™‚å¸«äº†è§£ä½ çš„æ—¥å¸¸è² è·</span>
        </div>

        <div class="field-group">
          <div class="field-row">
            <div class="field-label">è·æ¥­</div>
            <input id="c-job" type="text" placeholder="ä¾‹ï¼šè­¦å¯Ÿã€ä¸Šç­æ—ã€è­·ç†å¸«ã€é¤é£²æ¥­..." />
          </div>
          <div class="field-row">
            <div class="field-label">é‹å‹•ç¿’æ…£</div>
            <div class="chip-row" data-group="sport">
              <button type="button" class="chip" data-value="å¹¾ä¹ä¸é‹å‹•">å¹¾ä¹ä¸é‹å‹•</button>
              <button type="button" class="chip" data-value="æ¯é€±1-2æ¬¡">æ¯é€±1-2æ¬¡</button>
              <button type="button" class="chip" data-value="æ¯é€±3æ¬¡ä»¥ä¸Š">æ¯é€±3æ¬¡ä»¥ä¸Š</button>
            </div>
          </div>
          <div class="field-row">
            <div class="field-label">å¸¸åšé‹å‹•</div>
            <textarea id="c-sport-detail" placeholder="ä¾‹ï¼šé‡è¨“ã€è·‘æ­¥ã€ç‘œçˆã€æ¸¸æ³³ã€çƒé¡é‹å‹•..."></textarea>
          </div>
          <div class="field-row">
            <div class="field-label">ç¡çœ ç‹€æ³</div>
            <div class="chip-row" data-group="sleep">
              <button type="button" class="chip" data-value="å®¹æ˜“å…¥ç¡ä¸”ç¡å¾—å¥½">å®¹æ˜“å…¥ç¡ä¸”ç¡å¾—å¥½</button>
              <button type="button" class="chip" data-value="å¶çˆ¾æ·ºçœ æˆ–é›£å…¥ç¡">å¶çˆ¾æ·ºçœ æˆ–é›£å…¥ç¡</button>
              <button type="button" class="chip" data-value="å¸¸å¸¸ç¡ä¸å¥½">å¸¸å¸¸ç¡ä¸å¥½</button>
            </div>
          </div>
        </div>

        <hr class="section-divider" />

        <div class="section-title">
          éå»ç—…å²èˆ‡å…¶ä»–è³‡è¨Š
          <span class="pill">å¯å¤šé¸</span>
        </div>

        <div class="field-group">
          <div class="field-row">
            <div class="field-label">æ›¾æ¥å—æ²»ç™‚</div>
            <div class="chip-row" data-group="past-treatment">
              <button type="button" class="chip" data-value="å¾©å¥ç§‘æ²»ç™‚">å¾©å¥ç§‘æ²»ç™‚</button>
              <button type="button" class="chip" data-value="ç‰©ç†æ²»ç™‚">ç‰©ç†æ²»ç™‚</button>
              <button type="button" class="chip" data-value="ä¸­é†«é‡ç¸">ä¸­é†«é‡ç¸</button>
              <button type="button" class="chip" data-value="æ°‘ä¿—ç™‚æ³•">æ°‘ä¿—ç™‚æ³•</button>
              <button type="button" class="chip" data-value="ç„¡ç‰¹åˆ¥æ²»ç™‚">ç„¡ç‰¹åˆ¥æ²»ç™‚</button>
            </div>
          </div>
          <div class="field-row">
            <div class="field-label">é‡å¤§ç—…å²/æ‰‹è¡“</div>
            <textarea id="c-history" placeholder="ä¾‹ï¼šæ¤é–“ç›¤çªå‡ºã€åå­—éŸŒå¸¶æ‰‹è¡“ã€å­å®®åˆ‡é™¤æ‰‹è¡“..."></textarea>
          </div>
          <div class="field-row">
            <div class="field-label">å…¶ä»–æƒ³è£œå……</div>
            <textarea id="c-note" placeholder="å¯è£œå……ä»»ä½•ä½ è¦ºå¾—èˆ‡é€™æ¬¡ä¸èˆ’æœç›¸é—œçš„è³‡è¨Šã€‚"></textarea>
          </div>
        </div>

        <div class="btn-row">
          <button id="btn-clear-client" type="button" class="btn-secondary">
            æ¸…é™¤æš«å­˜
          </button>
          <button id="btn-to-therapist" type="button" class="btn-primary">
            äº¤çµ¦æ²»ç™‚å¸«è©•ä¼°
          </button>
        </div>
      </section>

      <!-- æ²»ç™‚å¸«è©•ä¼°é  -->
      <section id="page-therapist" class="card hidden">
        <div class="card-header">
          <div>
            <div class="card-title">
              <span class="emoji">ğŸ©º</span>
              æ²»ç™‚å¸«è©•ä¼°èˆ‡ç´€éŒ„
            </div>
            <div class="card-subtitle">å·¦å´ç‚ºå€‹æ¡ˆå¡«å¯«å…§å®¹æ‘˜è¦ï¼Œå³å´ç‚ºæ²»ç™‚å¸«ç´€éŒ„å€ã€‚</div>
          </div>
        </div>

        <div class="card-subtitle">
          <span class="summary-visit">ç›®å‰ç‚ºç¬¬ <strong id="visit-count-label">1</strong> æ¬¡æ²»ç™‚ç´€éŒ„ã€‚</span>
        </div>

        <div style="display:grid;grid-template-columns:minmax(0,1.2fr) minmax(0,1.8fr);gap:12px;">
          <div class="pt-section">
            <div class="pt-section-title">
              å€‹æ¡ˆæ‘˜è¦
              <span class="pill">å¾å€‹æ¡ˆå¡«å¯«è³‡æ–™è‡ªå‹•å¸¶å…¥</span>
            </div>
            <div class="pt-section-body">
              <ul class="summary-list">
                <li class="summary-item">
                  <div class="summary-label">å§“å</div>
                  <div class="summary-value" id="s-name">
                    <span class="summary-empty">âš  æœªå¡«</span>
                  </div>
                </li>
                <li class="summary-item">
                  <div class="summary-label">å¹´é½¡/æ€§åˆ¥</div>
                  <div class="summary-value" id="s-age-gender">
                    <span class="summary-empty">âš  æœªå¡«</span>
                  </div>
                </li>
                <li class="summary-item">
                  <div class="summary-label">æ…£ç”¨æ‰‹</div>
                  <div class="summary-value" id="s-handedness">
                    <span class="summary-empty">âš  æœªå¡«</span>
                  </div>
                </li>
                <li class="summary-item">
                  <div class="summary-label">ç”Ÿæ´»å‹æ…‹</div>
                  <div class="summary-value" id="s-lifestyle">
                    <span class="summary-empty">âš  æœªå¡«</span>
                  </div>
                </li>
                <li class="summary-item">
                  <div class="summary-label">ä¸»è¨´</div>
                  <div class="summary-value" id="s-main-complaint">
                    <span class="summary-empty">âš  æœªå¡«</span>
                  </div>
                </li>
                <li class="summary-item">
                  <div class="summary-label">ç–¼ç—›å‹æ…‹</div>
                  <div class="summary-value" id="s-pain-quality">
                    <span class="summary-empty">âš  æœªå¡«</span>
                  </div>
                </li>
                <li class="summary-item">
                  <div class="summary-label">èª˜ç™¼/ç·©è§£</div>
                  <div class="summary-value" id="s-aggravating-relieving">
                    <span class="summary-empty">âš  æœªå¡«</span>
                  </div>
                </li>
                <li class="summary-item">
                  <div class="summary-label">VAS</div>
                  <div class="summary-value" id="s-vas">
                    <span class="summary-empty">âš  æœªå¡«</span>
                  </div>
                </li>
                <li class="summary-item">
                  <div class="summary-label">å·¥ä½œ/é‹å‹•</div>
                  <div class="summary-value" id="s-job-sport">
                    <span class="summary-empty">âš  æœªå¡«</span>
                  </div>
                </li>
                <li class="summary-item">
                  <div class="summary-label">ç¡çœ </div>
                  <div class="summary-value" id="s-sleep">
                    <span class="summary-empty">âš  æœªå¡«</span>
                  </div>
                </li>
                <li class="summary-item">
                  <div class="summary-label">ç—…å²</div>
                  <div class="summary-value" id="s-history">
                    <span class="summary-empty">âš  æœªå¡«</span>
                  </div>
                </li>
              </ul>
            </div>

            <div id="vas-chart-wrap" class="vas-chart-wrapper">
              <div class="vas-chart-title">
                VAS ç–¼ç—›è¶¨å‹¢
                <span class="pill">ä¸€æ¬¡ä»¥ä¸Šæ²»ç™‚æ™‚æœƒå‡ºç¾è¶¨å‹¢åœ–</span>
              </div>
              <div class="vas-chart-hint">
                Xè»¸ï¼šæ²»ç™‚æ¬¡æ•¸ï¼›Yè»¸ï¼šç–¼ç—›åˆ†æ•¸ï¼ˆ0ï½10ï¼‰ã€‚<br />
                è—ç·šï¼šç›®å‰ç–¼ç—›ï¼›ç´…ç·šï¼šæœ€å¤§ç–¼ç—›ã€‚
              </div>
              <div class="vas-chart-canvas-wrap">
                <canvas id="vas-chart"></canvas>
              </div>
            </div>
          </div>

          <div>
            <div class="pt-section">
              <div class="pt-section-title">
                ç‰©ç†æ²»ç™‚å¸«è©•ä¼°
                <span class="pill">åƒ…æ²»ç™‚å¸«å¡«å¯«</span>
              </div>
              <div class="field-group">
                <div class="field-row">
                  <div class="field-label">åˆæ­¥å°è±¡</div>
                  <textarea id="pt-impression" placeholder="ä¾‹ï¼šç–‘ä¼¼å³å´è–¦é«‚é—œç¯€åŠŸèƒ½éšœç¤™åˆä½µè…°æ¤ç©©å®šåº¦ä¸è¶³..."></textarea>
                </div>
                <div class="field-row">
                  <div class="field-label">æª¢æŸ¥é …ç›®</div>
                  <textarea id="pt-test" placeholder="ä¾‹ï¼šSlump testã€SLRã€PAã€ä¸»å‹•å±ˆä¼¸ã€å–®è…³ç«™ç«‹æ§åˆ¶..."></textarea>
                </div>
                <div class="field-row">
                  <div class="field-label">æ²»ç™‚ç­–ç•¥</div>
                  <textarea id="pt-plan" placeholder="ä¾‹ï¼šæ·±å±¤çµ„ç¹”æ”¾é¬†ã€é—œç¯€é¬†å‹•ã€æ ¸å¿ƒæ§åˆ¶è¨“ç·´ã€å‹•ä½œæ¨¡å¼èª¿æ•´..."></textarea>
                </div>
              </div>
            </div>

            <div class="pt-section">
              <div class="pt-section-title">
                æ²»ç™‚å…§å®¹ç´€éŒ„
                <span class="pill">å¯ä½œç‚ºä¸‹æ¬¡è¤‡ç¿’ä¾æ“š</span>
              </div>
              <div class="field-group">
                <div class="field-row">
                  <div class="field-label">æœ¬æ¬¡é‡é»</div>
                  <textarea id="pt-today-focus" placeholder="ä¾‹ï¼šæ”¾é¬†å³è…¿å¾Œè‚Œç¾¤ã€è¨“ç·´éª¨ç›†ç©©å®šã€æ•™è‚²ä¹…åä¸­çš„ä¼‘æ¯ç­–ç•¥..."></textarea>
                </div>
                <div class="field-row">
                  <div class="field-label">å›å®¶ä½œæ¥­</div>
                  <textarea id="pt-homework" placeholder="ä¾‹ï¼šæ¯æ—¥3å›åˆè…°æ¤æ¸›å£“å‹•ä½œã€è‡€è‚Œå•Ÿå‹•è¨“ç·´ã€é¿å…ä¹…åè¶…é30åˆ†é˜..."></textarea>
                </div>
                <div class="field-row">
                  <div class="field-label">ä¸‹æ¬¡ç›®æ¨™</div>
                  <textarea id="pt-next-goal" placeholder="ä¾‹ï¼šå¸Œæœ›èƒ½å°‡åå§¿ç–¼ç—›å¾7åˆ†é™åˆ°5åˆ†ä»¥ä¸‹..."></textarea>
                </div>
              </div>
            </div>

            <div class="btn-row">
              <button id="btn-complete-visit" type="button" class="btn-primary">
                å®Œæˆè©•ä¼°ï¼ˆå„²å­˜å€‹æ¡ˆç´€éŒ„ï¼‰
              </button>
              <button id="btn-export-json" type="button" class="btn-secondary">
                åŒ¯å‡ºå€‹æ¡ˆè³‡æ–™åº«
              </button>
            </div>
          </div>
        </div>
      </section>

      <!-- å€‹æ¡ˆç®¡ç†é  -->
      <section id="page-cases" class="card hidden">
        <div class="card-header">
          <div>
            <div class="card-title">
              <span class="emoji">ğŸ“‚</span>
              å€‹æ¡ˆåˆ—è¡¨èˆ‡æœå°‹
            </div>
            <div class="card-subtitle">é»é¸å€‹æ¡ˆå¯é‡æ–°è¼‰å…¥åˆ°ã€Œå€‹æ¡ˆå¡«å¯«ã€èˆ‡ã€Œæ²»ç™‚å¸«è©•ä¼°ã€é é¢ã€‚</div>
          </div>
        </div>

        <div class="case-search-row">
          <input id="case-search" type="text" placeholder="æœå°‹å§“åæˆ–ä¸»è¨´é—œéµå­—..." />
          <span class="case-count" id="case-count-label">å…± 0 ç­†å€‹æ¡ˆ</span>
        </div>

        <div class="case-list-container" id="case-list">
          <div class="case-list-header">
            <span>å§“å / å¹´é½¡</span>
            <span>ä¸»è¨´ &nbsp;|&nbsp; VAS</span>
            <span style="text-align:right;">æ²»ç™‚æ¬¡æ•¸ / åˆªé™¤</span>
          </div>
          <div class="case-list-empty">å°šæœªå»ºç«‹ä»»ä½•å€‹æ¡ˆç´€éŒ„ã€‚</div>
        </div>

        <div class="case-import-row">
          <button id="btn-import-json" type="button" class="btn-pill-small">
            åŒ¯å…¥å€‹æ¡ˆè³‡æ–™åº« JSON
          </button>
          <span>åŒ¯å‡ºå¾Œçš„ JSON æª”å¯åœ¨æ­¤é‡æ–°è¼‰å…¥ï¼Œé©åˆå¤šè£ç½®å‚™ä»½ã€‚</span>
          <input type="file" id="importFile" accept="application/json" style="display:none;" />
        </div>
      </section>
    </main>
  </div>

  <script>
(() => {
  const STORAGE = {
    client: "pt_eval_client_v1",
    therapist: "pt_eval_therapist_v1",
    library: "pt_eval_case_library_v1",
    visit: "pt_eval_visit_v1",
    currentCaseId: "pt_eval_current_case_id_v1",
    currentRecordIndex: "pt_eval_current_record_idx_v1"
  };

  // === Supabase è¨­å®šï¼ˆè«‹å¡«å…¥è‡ªå·±çš„ URL èˆ‡ anon keyï¼‰ ===
  const SUPABASE_URL = "https://yvacvzulhaaehffbhttt.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl2YWN2enVsaGFhZWhmZmJodHR0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4OTg1ODUsImV4cCI6MjA4MTQ3NDU4NX0.6tgcZoxClNCn9y5lft_H1XF2pfQGPb6beehSuQLEMD0";
  let supabaseClient = null;
  if (window.supabase && SUPABASE_URL && SUPABASE_ANON_KEY) {
    const { createClient } = window.supabase;
    supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  }

  // === ç™»å…¥è¨­å®š ===
  // å°‡ç™»å…¥ç‹€æ…‹å­˜åœ¨ localStorageï¼Œé¿å…æ¯æ¬¡é‡é–‹éƒ½è¦è¼¸å…¥ã€‚
  // æ³¨æ„ï¼šå¯¦éš›å¸³è™Ÿå¯†ç¢¼é©—è­‰äº¤çµ¦ Supabaseï¼Œé€™è£¡åªè² è²¬æ§åˆ¶å‰ç«¯æ˜¯å¦é¡¯ç¤ºä¸»ç³»çµ±ã€‚
  const AUTH_KEY = "physionotes_auth_v1";

  function isLoggedIn() {
    return localStorage.getItem(AUTH_KEY) === "yes";
  }

  function setLoggedIn(flag) {
    if (flag) localStorage.setItem(AUTH_KEY, "yes");
    else localStorage.removeItem(AUTH_KEY);
  }

  function applyAuthUI() {
    const app = document.getElementById("app-root");
    const login = document.getElementById("login-screen");
    if (!app || !login) return;

    if (isLoggedIn()) {
      login.classList.add("hidden");
      app.classList.remove("hidden");
    } else {
      app.classList.add("hidden");
      login.classList.remove("hidden");
    }
  }

  const $  = (s, r=document)=>r.querySelector(s);
  const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));

  function parse(json, fallback) {
    try {
      return json ? JSON.parse(json) : fallback;
    } catch {
      return fallback;
    }
  }

  const loadClient    = ()=>parse(localStorage.getItem(STORAGE.client),{});
  const saveClient    = (d)=>localStorage.setItem(STORAGE.client,JSON.stringify(d||{}));
  const loadTherapist = ()=>parse(localStorage.getItem(STORAGE.therapist),{});
  const saveTherapist = (d)=>localStorage.setItem(STORAGE.therapist,JSON.stringify(d||{}));
  const loadVisit     = ()=>parse(localStorage.getItem(STORAGE.visit),{ vasNow:null, vasMax:null });
  const saveVisit     = (d)=>localStorage.setItem(STORAGE.visit,JSON.stringify(d||{ vasNow:null, vasMax:null }));
  const resetVisit    = ()=>saveVisit({ vasNow:null, vasMax:null });

  const loadLib = ()=>parse(localStorage.getItem(STORAGE.library),{});
  const saveLib = (d)=>localStorage.setItem(STORAGE.library,JSON.stringify(d||{}));

  const getCurrentCaseId = ()=>localStorage.getItem(STORAGE.currentCaseId);
  const setCurrentCaseId = (id)=> id ? localStorage.setItem(STORAGE.currentCaseId,id) : localStorage.removeItem(STORAGE.currentCaseId);

  const getCurrentRecordIndex = ()=> {
    const v = localStorage.getItem(STORAGE.currentRecordIndex);
    return v!=null ? Number(v) : null;
  };
  const setCurrentRecordIndex = (idx)=> {
    if (idx==null || isNaN(idx)) localStorage.removeItem(STORAGE.currentRecordIndex);
    else localStorage.setItem(STORAGE.currentRecordIndex,String(idx));
  };

  function ensureCaseShape(item){
    if(!item || typeof item!=="object") item={};
    if(!item.client) item.client={};
    if(!item.records) item.records=[];
    return item;
  }

  function buildClientFromUI(){
    const g = (id)=>document.getElementById(id);
    const getGroup = (groupName)=>{
      const wrap = document.querySelector(`.chip-row[data-group="${groupName}"]`);
      if(!wrap) return "";
      const act = wrap.querySelector(".chip.active");
      return act ? act.dataset.value || act.textContent.trim() : "";
    };
    const getMultiGroup = (groupName)=>{
      const wrap = document.querySelector(`.chip-row[data-group="${groupName}"]`);
      if(!wrap) return [];
      return Array.from(wrap.querySelectorAll(".chip.active")).map(el=>el.dataset.value || el.textContent.trim());
    };

    return {
      name       : g("c-name")?.value.trim() || "",
      age        : g("c-age")?.value.trim() || "",
      gender     : getGroup("gender") || "",
      handedness : getGroup("handedness") || "",
      lifestyle  : getMultiGroup("lifestyle"),
      mainComplaint : g("c-main-complaint")?.value.trim() || "",
      painArea   : getMultiGroup("pain-area"),
      painQuality: getMultiGroup("pain-quality"),
      aggravating: g("c-aggravating")?.value.trim() || "",
      relieving  : g("c-relieving")?.value.trim() || "",
      job        : g("c-job")?.value.trim() || "",
      sportFreq  : getGroup("sport") || "",
      sportDetail: g("c-sport-detail")?.value.trim() || "",
      sleep      : getGroup("sleep") || "",
      pastTreatment : getMultiGroup("past-treatment"),
      history    : g("c-history")?.value.trim() || "",
      note       : g("c-note")?.value.trim() || ""
    };
  }

  function applyClientToUI(c){
    const g = (id)=>document.getElementById(id);
    const setVal = (id,v)=>{ if(g(id)) g(id).value = v ?? ""; };

    setVal("c-name",c.name||"");
    setVal("c-age",c.age||"");
    setVal("c-main-complaint",c.mainComplaint||"");
    setVal("c-aggravating",c.aggravating||"");
    setVal("c-relieving",c.relieving||"");
    setVal("c-job",c.job||"");
    setVal("c-sport-detail",c.sportDetail||"");
    setVal("c-history",c.history||"");
    setVal("c-note",c.note||"");

    const clearGroup = (groupName)=>{
      const wrap = document.querySelector(`.chip-row[data-group="${groupName}"]`);
      if(!wrap) return;
      wrap.querySelectorAll(".chip").forEach(el=>el.classList.remove("active"));
    };
    const setSingleGroup = (groupName,v)=>{
      clearGroup(groupName);
      if(!v) return;
      const wrap = document.querySelector(`.chip-row[data-group="${groupName}"]`);
      if(!wrap) return;
      const target = Array.from(wrap.querySelectorAll(".chip")).find(el=>(el.dataset.value||el.textContent.trim())===v);
      if(target) target.classList.add("active");
    };
    const setMultiGroup = (groupName,arr)=>{
      clearGroup(groupName);
      if(!Array.isArray(arr)) return;
      const wrap = document.querySelector(`.chip-row[data-group="${groupName}"]`);
      if(!wrap) return;
      arr.forEach(v=>{
        const target = Array.from(wrap.querySelectorAll(".chip")).find(el=>(el.dataset.value||el.textContent.trim())===v);
        if(target) target.classList.add("active");
      });
    };

    setSingleGroup("gender",c.gender||"");
    setSingleGroup("handedness",c.handedness||"");
    setSingleGroup("sport",c.sportFreq||"");
    setSingleGroup("sleep",c.sleep||"");
    setMultiGroup("lifestyle",c.lifestyle||[]);
    setMultiGroup("pain-area",c.painArea||[]);
    setMultiGroup("pain-quality",c.painQuality||[]);
    setMultiGroup("past-treatment",c.pastTreatment||[]);
  }

  function buildTherapistFromUI(){
    const g = (id)=>document.getElementById(id);
    return {
      impression  : g("pt-impression")?.value.trim() || "",
      test        : g("pt-test")?.value.trim() || "",
      plan        : g("pt-plan")?.value.trim() || "",
      todayFocus  : g("pt-today-focus")?.value.trim() || "",
      homework    : g("pt-homework")?.value.trim() || "",
      nextGoal    : g("pt-next-goal")?.value.trim() || ""
    };
  }

  function applyTherapistToUI(t){
    const g = (id)=>document.getElementById(id);
    const setVal = (id,v)=>{ if(g(id)) g(id).value = v ?? ""; };

    setVal("pt-impression",t.impression||"");
    setVal("pt-test",t.test||"");
    setVal("pt-plan",t.plan||"");
    setVal("pt-today-focus",t.todayFocus||"");
    setVal("pt-homework",t.homework||"");
    setVal("pt-next-goal",t.nextGoal||"");
  }

  function applyVisitToUI(v){
    const nowSlider = document.getElementById("vas-now");
    const maxSlider = document.getElementById("vas-max");
    const nowLabel  = document.getElementById("vas-now-value");
    const maxLabel  = document.getElementById("vas-max-value");
    const visitCountLabel = document.getElementById("visit-count-label");

    const now = (v && v.vasNow!=null)? Number(v.vasNow) : 0;
    const mx  = (v && v.vasMax!=null)? Number(v.vasMax) : 0;

    if(nowSlider) nowSlider.value = String(now);
    if(nowLabel)  nowLabel.textContent = String(now);
    if(maxSlider) maxSlider.value = String(mx);
    if(maxLabel)  maxLabel.textContent = String(mx);

    const idx = getCurrentRecordIndex();
    if(visitCountLabel) {
      visitCountLabel.textContent = idx!=null ? String(idx+1) : "1";
    }
  }

  function buildVisitFromUI(){
    const nowSlider = document.getElementById("vas-now");
    const maxSlider = document.getElementById("vas-max");
    return {
      vasNow: nowSlider ? Number(nowSlider.value) : null,
      vasMax: maxSlider ? Number(maxSlider.value) : null
    };
  }

  function renderSummary(){
    const c = loadClient();
    const v = loadVisit();

    const setText = (id, val, allowWarning=false)=>{
      const el = document.getElementById(id);
      if(!el) return;
      if(val==null || val==="" || (Array.isArray(val) && val.length===0)){
        el.innerHTML = allowWarning
          ? '<span class="summary-warning">âš  æœªå¡«</span>'
          : '<span class="summary-empty">âš  æœªå¡«</span>';
      } else {
        el.textContent = val;
      }
    };

    const ageGenderParts = [];
    if(c.age) ageGenderParts.push(`${c.age} æ­²`);
    if(c.gender) ageGenderParts.push(c.gender);
    const ageGender = ageGenderParts.join("ï¼");

    setText("s-name", c.name || "", true);
    setText("s-age-gender", ageGender || "", true);
    setText("s-handedness", c.handedness||"", true);
    setText("s-lifestyle", (c.lifestyle||[]).join("ã€") || "", true);

    const painArea = (c.painArea||[]).join("ã€");
    const mainC    = c.mainComplaint || "";
    const mainStr  = [painArea, mainC].filter(Boolean).join("ï¼");
    setText("s-main-complaint", mainStr || "", true);

    setText("s-pain-quality", (c.painQuality||[]).join("ã€") || "", true);

    const agr = c.aggravating || "";
    const rel = c.relieving || "";
    const agrRel = [agr, rel].filter(Boolean).join("ï¼");
    setText("s-aggravating-relieving", agrRel || "", true);

    if(v && v.vasNow!=null && v.vasMax!=null){
      setText("s-vas", `ç›®å‰ ${v.vasNow} åˆ†ï¼Œæœ€ç—› ${v.vasMax} åˆ†`, true);
    } else if(v && v.vasNow!=null){
      setText("s-vas", `ç›®å‰ ${v.vasNow} åˆ†`, true);
    } else if(v && v.vasMax!=null){
      setText("s-vas", `æœ€ç—› ${v.vasMax} åˆ†`, true);
    } else {
      setText("s-vas", "", true);
    }

    const job = c.job || "";
    const sportFreq = c.sportFreq || "";
    const sportDetail = c.sportDetail || "";
    const jobSportParts = [job, sportFreq, sportDetail].filter(Boolean);
    setText("s-job-sport", jobSportParts.join("ï¼") || "", true);

    setText("s-sleep", c.sleep || "", true);

    const ptArr = (c.pastTreatment||[]);
    const history = c.history || "";
    const histParts = [];
    if(ptArr.length) histParts.push(`æ›¾æ¥å—ï¼š${ptArr.join("ã€")}`);
    if(history) histParts.push(history);
    setText("s-history", histParts.join("ï¼›") || "", true);

    renderVasChart();
  }

  function renderVasChart() {

    const wrap = document.getElementById("vas-chart-wrap");
    const cvs  = document.getElementById("vas-chart");
    if (!wrap || !cvs) return;

    const ctx = cvs.getContext("2d");
    if (!ctx) return;

    const caseId = getCurrentCaseId();
    if (!caseId) {
      wrap.style.display = "none";
      return;
    }
    const lib = loadLib();
    const item = ensureCaseShape(lib[caseId]);
    if (!item || !item.records || !item.records.length) {
      wrap.style.display = "none";
      return;
    }

    const N = item.records.length;
    const points = item.records
      .map((r, i) => ({
        idx: i + 1,
        vasNow: (r.visit && r.visit.vasNow != null) ? Number(r.visit.vasNow) : null,
        vasMax: (r.visit && r.visit.vasMax != null) ? Number(r.visit.vasMax) : null,
      }))
      .filter(p => p.vasNow != null || p.vasMax != null);

    if (points.length < 1) {
      wrap.style.display = "none";
      return;
    }
    wrap.style.display = "block";

    const W = cvs.width = (cvs.clientWidth || (cvs.parentElement ? cvs.parentElement.clientWidth : 0) || 320);
    const H = cvs.height || 180;
    ctx.clearRect(0, 0, W, H);

    const padL=36, padR=14, padT=14, padB=60;
    const plotW = W - padL - padR;
    const plotH = H - padT - padB;
    if(plotW<=0 || plotH<=0) return;

    ctx.strokeStyle="#94a3b8";
    ctx.lineWidth=1;
    ctx.beginPath();
    ctx.moveTo(padL,padT);
    ctx.lineTo(padL,H-padB);
    ctx.lineTo(W-padR,H-padB);
    ctx.stroke();

    ctx.fillStyle="#475569";
    ctx.font="12px sans-serif";

    [0,5,10].forEach(v=>{
      const y = (H-padB) - plotH*(v/10);
      ctx.beginPath(); ctx.moveTo(padL-4,y); ctx.lineTo(padL,y); ctx.stroke();
      ctx.fillText(String(v), 8, y+4);
    });

    let step=1;
    if(N>20) step=5;
    else if(N>10) step=2;

    for(let i=1;i<=N;i+=step){
      const x = padL + plotW*((i-1)/(Math.max(1,N-1)));
      ctx.beginPath(); ctx.moveTo(x,H-padB); ctx.lineTo(x,H-padB+4); ctx.stroke();
      ctx.fillText(String(i), x-3, H-padB+16);
    }
    if(N>1 && ((N-1) % step) !== 0){
      const x = padL + plotW;
      ctx.beginPath(); ctx.moveTo(x,H-padB); ctx.lineTo(x,H-padB+4); ctx.stroke();
      ctx.fillText(String(N), x-3, H-padB+16);
    }

    const legendY = H - padB + 33;
    ctx.font="13px sans-serif";

    ctx.fillStyle="#2563eb";
    ctx.fillText("ç›®å‰ç–¼ç—›ï¼ˆè—ï¼‰", padL, legendY);

    ctx.fillStyle="#dc2626";
    ctx.fillText("æœ€å¤§ç–¼ç—›ï¼ˆç´…ï¼‰", padL, legendY + 20);

    ctx.strokeStyle="#2563eb";
    ctx.lineWidth=2;
    ctx.beginPath();
    let firstNow = true;
    points.forEach((p)=>{
      if(p.vasNow==null) return;
      const x = padL + plotW*((p.idx-1)/(Math.max(1,N-1)));
      const y = (H-padB) - plotH*(p.vasNow/10);
      if (firstNow) { ctx.moveTo(x,y); firstNow=false; }
      else ctx.lineTo(x,y);
    });
    if (!firstNow) ctx.stroke();

    ctx.strokeStyle="#dc2626";
    ctx.lineWidth=2;
    ctx.beginPath();
    let firstMax = true;
    points.forEach((p)=>{
      if(p.vasMax==null) return;
      const x = padL + plotW*((p.idx-1)/(Math.max(1,N-1)));
      const y = (H-padB) - plotH*(p.vasMax/10);
      if (firstMax) { ctx.moveTo(x,y); firstMax=false; }
      else ctx.lineTo(x,y);
    });
    if (!firstMax) ctx.stroke();

    ctx.fillStyle="#2563eb";
    points.forEach(p=>{
      if(p.vasNow==null) return;
      const x = padL + plotW*((p.idx-1)/(Math.max(1,N-1)));
      const y = (H-padB) - plotH*(p.vasNow/10);
      ctx.beginPath(); ctx.arc(x,y,4,0,Math.PI*2); ctx.fill();
    });

    ctx.fillStyle="#dc2626";
    points.forEach(p=>{
      if(p.vasMax==null) return;
      const x = padL + plotW*((p.idx-1)/(Math.max(1,N-1)));
      const y = (H-padB) - plotH*(p.vasMax/10);
      ctx.beginPath(); ctx.arc(x,y,4,0,Math.PI*2); ctx.fill();
    });
  }

  function switchTab(targetId){
    document.querySelectorAll(".tab-btn").forEach(btn=>{
      const t = btn.getAttribute("data-target");
      if(t===targetId){
        btn.classList.add("active");
      } else {
        btn.classList.remove("active");
      }
    });

    document.querySelectorAll("main > section").forEach(sec=>{
      if(sec.id === targetId){
        sec.classList.remove("hidden");
      } else {
        sec.classList.add("hidden");
      }
    });

    if(targetId==="page-therapist"){
      renderSummary();
    }
    if(targetId==="page-cases"){
      renderCaseList();
    }
  }

  function renderCaseList(){
    const listEl = document.getElementById("case-list");
    const countLabel = document.getElementById("case-count-label");
    const searchInput = document.getElementById("case-search");
    if(!listEl || !countLabel) return;

    const q = (searchInput?.value || "").trim().toLowerCase();

    const lib = loadLib();
    const entries = Object.entries(lib);

    entries.sort((a,b)=>{
      const ai = ensureCaseShape(a[1]);
      const bi = ensureCaseShape(b[1]);
      const at = ai.lastUpdated || 0;
      const bt = bi.lastUpdated || 0;
      return bt - at;
    });

    const filtered = entries.filter(([id,item])=>{
      const c = ensureCaseShape(item).client || {};
      const name = (c.name||"").toLowerCase();
      const main = (c.mainComplaint||"").toLowerCase();
      if(!q) return true;
      return name.includes(q) || main.includes(q);
    });

    countLabel.textContent = `å…± ${filtered.length} ç­†å€‹æ¡ˆ`;

    const header = listEl.querySelector(".case-list-header");
    listEl.innerHTML = "";
    if(header) listEl.appendChild(header);

    if(filtered.length===0){
      const empty = document.createElement("div");
      empty.className = "case-list-empty";
      empty.textContent = "å°šæœªå»ºç«‹ä»»ä½•å€‹æ¡ˆç´€éŒ„ã€‚";
      listEl.appendChild(empty);
      return;
    }

    filtered.forEach(([id,item])=>{
      const data = ensureCaseShape(item);
      const c = data.client || {};
      const records = data.records||[];
      const visitCount = records.length || 1;
      const firstVisit = records[0] || {};
      const firstVisitData = firstVisit.visit || {};
      const mainText = (c.mainComplaint||"").trim() || "ï¼ˆæœªå¡«ä¸»è¨´ï¼‰";
      const vasNow = (firstVisitData.vasNow!=null)? Number(firstVisitData.vasNow) : null;
      const vasMax = (firstVisitData.vasMax!=null)? Number(firstVisitData.vasMax) : null;
      let vasText = "VASï¼šæœªå¡«";
      if(vasNow!=null && vasMax!=null) vasText = `VASï¼š${vasNow}/${vasMax}`;
      else if(vasNow!=null) vasText = `VASï¼š${vasNow}`;
      else if(vasMax!=null) vasText = `VASï¼š-${vasMax}`;

      const row = document.createElement("div");
      row.className = "case-list-item";
      row.dataset.caseId = id;

      const nameAge = document.createElement("div");
      nameAge.className = "case-name";
      const agePart = c.age ? `ï½œ${c.age}æ­²` : "";
      nameAge.textContent = (c.name || "æœªå‘½åå€‹æ¡ˆ") + agePart;

      const mainVas = document.createElement("div");
      mainVas.className = "case-main";
      mainVas.textContent = `${mainText} ï½œ ${vasText}`;

      const visitInfo = document.createElement("div");
      visitInfo.className = "case-visit";
      visitInfo.innerHTML = `ç¬¬ <strong>${visitCount}</strong> æ¬¡æ²»ç™‚ &nbsp;`;

      const delBtn = document.createElement("button");
      delBtn.type = "button";
      delBtn.className = "btn-danger";
      delBtn.textContent = "åˆªé™¤";

      row.appendChild(nameAge);
      row.appendChild(mainVas);
      const visitWrap = document.createElement("div");
      visitWrap.style.display = "flex";
      visitWrap.style.alignItems = "center";
      visitWrap.style.justifyContent = "flex-end";
      visitWrap.style.gap = "6px";
      visitWrap.appendChild(visitInfo);
      visitWrap.appendChild(delBtn);
      row.appendChild(visitWrap);

      row.addEventListener("click",(e)=>{
        if(e.target === delBtn) return;
        loadCaseIntoUI(id);
        switchTab("page-client");
      });

      delBtn.addEventListener("click",(e)=>{
        e.stopPropagation();
        if(!confirm("ç¢ºå®šè¦åˆªé™¤æ­¤å€‹æ¡ˆï¼Ÿåˆªé™¤å¾Œç„¡æ³•å¾©åŸã€‚")) return;
        const lib2 = loadLib();
        delete lib2[id];
        saveLib(lib2);
        if(getCurrentCaseId()===id){
          setCurrentCaseId(null);
          setCurrentRecordIndex(null);
          saveClient({});
          saveTherapist({});
          resetVisit();
          applyClientToUI({});
          applyTherapistToUI({});
          applyVisitToUI({ vasNow:null, vasMax:null });
          renderSummary();
        }
        renderCaseList();
      });

      listEl.appendChild(row);
    });
  }

  function loadCaseIntoUI(id){
    const lib = loadLib();
    const item = ensureCaseShape(lib[id]);
    setCurrentCaseId(id);

    const c = item.client || {};
    applyClientToUI(c);

    const idx = (item.records && item.records.length>0) ? item.records.length-1 : 0;
    setCurrentRecordIndex(idx);

    const rec = item.records[idx] || {};
    const t = rec.therapist || {};
    const v = rec.visit || { vasNow:null, vasMax:null };

    applyTherapistToUI(t);
    saveTherapist(t);

    saveVisit(v);
    applyVisitToUI(v);

    saveClient(c);
    renderSummary();
  }

  function exportCasesToFile(){
    const lib = loadLib();
    const blob = new Blob([JSON.stringify(lib,null,2)],{ type:"application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "physionotes_cases.json";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  function importCasesFromFile(file){
    if(!file) return;
    const reader = new FileReader();
    reader.onload = (e)=>{
      try{
        const text = e.target.result;
        const json = JSON.parse(text);
        if(typeof json!=="object" || Array.isArray(json)) throw new Error("not object");
        saveLib(json);
        alert("åŒ¯å…¥å®Œæˆï¼");
        renderCaseList();
      }catch(err){
        console.error(err);
        alert("åŒ¯å…¥å¤±æ•—ï¼šéåˆæ³•JSON");
      }
      const inp = document.getElementById("importFile");
      if(inp) inp.value = "";
    };
    reader.readAsText(file);
  }

  function bind(){
    document.querySelectorAll(".tab-btn").forEach(btn=>{
      btn.addEventListener("click",()=>{
        const target = btn.getAttribute("data-target");
        if(target) switchTab(target);
      });
    });

    document.querySelectorAll(".chip-row").forEach(row=>{
      const isMulti = row.dataset.group === "lifestyle"
        || row.dataset.group === "pain-area"
        || row.dataset.group === "pain-quality"
        || row.dataset.group === "past-treatment";

      row.addEventListener("click",(e)=>{
        const chip = e.target.closest(".chip");
        if(!chip) return;
        if(isMulti){
          chip.classList.toggle("active");
        } else {
          row.querySelectorAll(".chip").forEach(c=>c.classList.remove("active"));
          chip.classList.add("active");
        }
        const c = buildClientFromUI();
        saveClient(c);
        renderSummary();
      });
    });

    ["c-name","c-age","c-main-complaint","c-aggravating","c-relieving",
     "c-job","c-sport-detail","c-history","c-note"].forEach(id=>{
      const el = document.getElementById(id);
      if(el){
        el.addEventListener("input",()=>{
          const c = buildClientFromUI();
          saveClient(c);
          renderSummary();
        });
      }
    });

    ["vas-now","vas-max"].forEach(id=>{
      const slider = document.getElementById(id);
      const label  = document.getElementById(id+"-value");
      if(slider && label){
        slider.addEventListener("input",()=>{
          label.textContent = slider.value;
        });
        slider.addEventListener("change",()=>{
          const visit = buildVisitFromUI();
          saveVisit(visit);
          const curId = getCurrentCaseId();
          const lib = loadLib();
          let item;
          if(curId && lib[curId]){
            item = ensureCaseShape(lib[curId]);
          } else {
            const newId = "case_"+Date.now();
            setCurrentCaseId(newId);
            item = ensureCaseShape({ client: loadClient(), records: [] });
          }

          let idx = getCurrentRecordIndex();
          if(idx==null || idx<0){
            idx = item.records.length>0 ? item.records.length-1 : 0;
            setCurrentRecordIndex(idx);
          }
          if(!item.records[idx]) item.records[idx] = { therapist:{}, visit:{} };
          item.records[idx].visit = visit;
          item.lastUpdated = Date.now();
          lib[getCurrentCaseId()] = item;
          saveLib(lib);

          const v = buildVisitFromUI();
          saveVisit(v);
          applyVisitToUI(v);
          renderSummary();
        });
      }
    });

    const btnClear = document.getElementById("btn-clear-client");
    if(btnClear){
      btnClear.addEventListener("click",()=>{
        if(!confirm("ç¢ºå®šè¦æ¸…é™¤ç›®å‰å€‹æ¡ˆå¡«å¯«è³‡æ–™èˆ‡æš«å­˜VASå—ï¼Ÿ")) return;
        saveClient({});
        resetVisit();
        setCurrentCaseId(null);
        setCurrentRecordIndex(null);
        applyClientToUI({});
        applyVisitToUI({ vasNow:null, vasMax:null });
        renderSummary();
      });
    }

    const btnToPT = document.getElementById("btn-to-therapist");
    if(btnToPT){
      btnToPT.addEventListener("click",()=>{
        const c = buildClientFromUI();
        saveClient(c);
        renderSummary();
        switchTab("page-therapist");
      });
    }

    const btnComplete = document.getElementById("btn-complete-visit");
    if(btnComplete){
      btnComplete.addEventListener("click",()=>{
        const client  = buildClientFromUI();
        const therapist = buildTherapistFromUI();
        const visit   = buildVisitFromUI();

        saveClient(client);
        saveTherapist(therapist);
        saveVisit(visit);

        const lib = loadLib();
        let caseId = getCurrentCaseId();
        if(!caseId){
          caseId = "case_"+Date.now();
          setCurrentCaseId(caseId);
        }
        const item = ensureCaseShape(lib[caseId]);

        let idx = getCurrentRecordIndex();
        if(idx==null || idx<0 || idx>=item.records.length){
          idx = item.records.length;
          setCurrentRecordIndex(idx);
        }

        item.client = client;
        item.records[idx] = {
          therapist,
          visit
        };
        item.lastUpdated = Date.now();
        lib[caseId] = item;
        saveLib(lib);

        const f = document.getElementById("case-count-label");
        renderSummary();
        alert("æœ¬æ¬¡æ²»ç™‚ç´€éŒ„å·²å®Œæˆä¸¦å¯«å…¥å€‹æ¡ˆè³‡æ–™åº«ã€‚");
        renderCaseList();
      });
    }

    const btnExport = document.getElementById("btn-export-json");
    if(btnExport){
      btnExport.addEventListener("click",exportCasesToFile);
    }

    const btnImport = document.getElementById("btn-import-json");
    const fileInput = document.getElementById("importFile");
    if(btnImport && fileInput){
      btnImport.addEventListener("click",()=>{
        fileInput.click();
      });
      fileInput.addEventListener("change",()=>{
        if(fileInput.files && fileInput.files[0]){
          importCasesFromFile(fileInput.files[0]);
        }
      });
    }

    const caseSearch = document.getElementById("case-search");
    if(caseSearch){
      caseSearch.addEventListener("input",renderCaseList);
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    bind();

    const client = loadClient();
    applyClientToUI(client);
    const visit = loadVisit();
    applyVisitToUI(visit);
    renderSummary();

    const loginBtn   = document.getElementById("btn-login");
    const pwInput    = document.getElementById("login-password");
    const emailInput = document.getElementById("login-email");

    if (loginBtn && pwInput) {
      loginBtn.addEventListener("click", async () => {
        const pw    = pwInput.value.trim();
        const email = emailInput ? emailInput.value.trim() : "";

        if (!email || !pw) {
          alert("è«‹è¼¸å…¥å¸³è™Ÿèˆ‡å¯†ç¢¼");
          return;
        }
        if (!supabaseClient) {
          alert("ç™»å…¥ç³»çµ±å°šæœªè¨­å®š Supabaseï¼Œè«‹ç¨å¾Œå†è©¦æˆ–è¯çµ¡ç®¡ç†è€…ã€‚");
          return;
        }
        try {
          const { data, error } = await supabaseClient.auth.signInWithPassword({
            email,
            password: pw
          });
          if (error) {
            console.error("Supabase login error", error);
            alert("ç™»å…¥å¤±æ•—ï¼š" + (error.message || "è«‹ç¢ºèªå¸³è™Ÿå¯†ç¢¼"));
            return;
          }
          setLoggedIn(true);
          applyAuthUI();
          pwInput.value = "";
          if (emailInput) emailInput.value = "";
        } catch (err) {
          console.error("login error", err);
          alert("ç™»å…¥æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦");
        }
      });

      pwInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") loginBtn.click();
      });
      if (emailInput) {
        emailInput.addEventListener("keydown", (e) => {
          if (e.key === "Enter") loginBtn.click();
        });
      }
    }

    const logoutBtn = document.getElementById("btn-logout");
    if (logoutBtn) {
      logoutBtn.addEventListener("click", () => {
        if (!confirm("ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ")) return;
        setLoggedIn(false);
        applyAuthUI();
      });
    }

    applyAuthUI();
  });

})();
  </script>
</body>
</html>
